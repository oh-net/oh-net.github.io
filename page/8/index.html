<!DOCTYPE html>













<html class="theme-next gemini" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=6.6.0" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.6.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.6.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.6.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.6.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '6.6.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="$$ Welcome $$">
<meta property="og:type" content="website">
<meta property="og:title" content="Technician">
<meta property="og:url" content="https://hero.triple.net.cn/page/8/index.html">
<meta property="og:site_name" content="Technician">
<meta property="og:description" content="$$ Welcome $$">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Technician">
<meta name="twitter:description" content="$$ Welcome $$">






  <link rel="canonical" href="https://hero.triple.net.cn/page/8/">



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>Technician</title>
  











  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Technician</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <p class="site-subtitle">Yet another note</p>
      
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
    
      
    

    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>关于</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-sitemap">

    
    
    
      
    

    

    <a href="/sitemap.xml" rel="section"><i class="menu-item-icon fa fa-fw fa-sitemap"></i> <br>站点地图</a>

  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>搜索</a>
        </li>
      
    </ul>
  

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://hero.triple.net.cn/2017/08/08/xfce-ibus-e4-bf-ae-e6-94-b9-e8-be-93-e5-85-a5-e6-b3-95-e9-a1-ba-e5-ba-8f/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="$$ Welcome $$">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Technician">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2017/08/08/xfce-ibus-e4-bf-ae-e6-94-b9-e8-be-93-e5-85-a5-e6-b3-95-e9-a1-ba-e5-ba-8f/" class="post-title-link" itemprop="https://hero.triple.net.cn/page/8/index.html">xfce/iBus 修改输入法顺序</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2017-08-08 10:47:05" itemprop="dateCreated datePublished" datetime="2017-08-08T10:47:05+08:00">2017-08-08</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-12-12 17:24:02" itemprop="dateModified" datetime="2018-12-12T17:24:02+08:00">2018-12-12</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/操作系统/" itemprop="url" rel="index"><span itemprop="name">操作系统</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>使用 <code>dconf</code> 命令（如果有找到GUI界面更好） 打开 dconf Editor &gt; desktop &gt; ibus &gt; general &gt; engines-oder 可以调整</p>
<hr>
<p>还有就是要确认是不是当前桌面环境使用的键盘布局有问题 如果使用</p>
<pre><code>dconf write /desktop/ibus/general/engines-order [&apos;xkb:us::eng&apos;, &apos;libpinyin&apos;]
</code></pre><p>提示</p>
<blockquote>
<p>error: 1-10:unknown keyword</p>
</blockquote>
<p>更应该注意。 可以在iBus 首选项-高级 里面把布局改成 “使用系统键盘”</p>

          
        
      
    </div>

    

    
    
    

    

    
       
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://hero.triple.net.cn/2017/08/08/jms-e5-9c-a8-springboot-e4-b8-ad-e7-9a-84-e4-bd-bf-e7-94-a8-e5-90-8e-e7-ab-af-e6-8e-98-e9-87-91/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="$$ Welcome $$">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Technician">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2017/08/08/jms-e5-9c-a8-springboot-e4-b8-ad-e7-9a-84-e4-bd-bf-e7-94-a8-e5-90-8e-e7-ab-af-e6-8e-98-e9-87-91/" class="post-title-link" itemprop="https://hero.triple.net.cn/page/8/index.html">JMS 在 SpringBoot 中的使用 - 后端 - 掘金</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2017-08-08 10:21:13" itemprop="dateCreated datePublished" datetime="2017-08-08T10:21:13+08:00">2017-08-08</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-12-12 17:19:37" itemprop="dateModified" datetime="2018-12-12T17:19:37+08:00">2018-12-12</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/技术分类/" itemprop="url" rel="index"><span itemprop="name">技术分类</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>JMS 在 SpringBoot 中的使用</strong></p>
<h2 id="当前环境"><a href="#当前环境" class="headerlink" title="当前环境"></a><a href="https://juejin.im/entry/593779c52f301e006b26387d#当前环境" target="_blank" rel="noopener"></a>当前环境</h2><ol>
<li>Mac OS 10.11.x</li>
<li>docker 1.12.1</li>
<li>JDK 1.8</li>
<li>SpringBoot 1.5</li>
</ol>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a><a href="https://juejin.im/entry/593779c52f301e006b26387d#前言" target="_blank" rel="noopener"></a>前言</h2><p>基于之前一篇<a href="https://link.juejin.im/?target=https%3A%2F%2Fgithub.com%2FjasonGeng88%2Fblog%2Fblob%2Fmaster%2F201705%2FMQ.md" target="_blank" rel="noopener">“一个故事告诉你什么是消息队列”</a>，了解了消息队列的使用场景以及相关的特性。本文主要讲述消息服务在 JAVA 中的使用。</p>
<p>市面上的有关消息队列的技术选型非常多，如果我们的代码框架要支持不同的消息实现，在保证框架具有较高扩展性的前提下，我们势必要进行一定的封装。</p>
<p>在 JAVA 中，大可不必如此。因为 JAVA 已经制定了一套标准的 JMS 规范。该规范定义了一套通用的接口和相关语义，提供了诸如持久、验证和事务的消息服务，其最主要的目的是允许Java应用程序访问现有的消息中间件。就和 JDBC 一样。</p>
<h2 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a><a href="https://juejin.im/entry/593779c52f301e006b26387d#基本概念" target="_blank" rel="noopener"></a>基本概念</h2><p>在介绍具体的使用之前，先简单介绍一下 JMS 的一些基本知识。这里我打算分为 3 部分来介绍，即 消息队列（MQ）的连接、消息发送与消息接收。</p>
<p><em><strong>这里我们的技术选型是 SpringBoot、JMS、ActiveMQ</strong></em></p>
<p><em>为了更好的理解 JMS，这里没有使用 SpringBoot 零配置来搭建项目</em></p>
<h3 id="MQ-的连接"><a href="#MQ-的连接" class="headerlink" title="MQ 的连接"></a><a href="https://juejin.im/entry/593779c52f301e006b26387d#mq-的连接" target="_blank" rel="noopener"></a>MQ 的连接</h3><p>使用 MQ 的第一步一定是先连接 MQ。因为这里使用的是 JMS 规范，对于任何遵守 JMS 规范的 MQ 来说，都会实现相应的<code>ConnectionFactory</code>接口，因此我们只需要创建一个<code>ConnectionFactory</code>工厂类，由它来实现 MQ 的连接，以及封装一系列特性的 MQ 参数。</p>
<p>例子：这里我们以 ActiveMQ 为例，</p>
<p>maven 依赖：</p>
<pre><code>&lt;parent&gt;
    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
    &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;
    &lt;version&gt;1.5.3.RELEASE&lt;/version&gt;
&lt;/parent&gt;

&lt;dependencies&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
        &lt;artifactId&gt;spring-boot-starter-activemq&lt;/artifactId&gt;
    &lt;/dependency&gt;
&lt;/dependencies&gt;
</code></pre><p>创建 ActiveMQ 连接工厂：</p>
<pre><code>@Bean
public ConnectionFactory connectionFactory(){

    ActiveMQConnectionFactory connectionFactory = new ActiveMQConnectionFactory();
    connectionFactory.setBrokerURL(ActiveMQ_URL);
    connectionFactory.setUserName(ActiveMQ_USER);
    connectionFactory.setPassword(ActiveMQ_PASSWORD);
    return connectionFactory;

}
</code></pre><h3 id="消息发送"><a href="#消息发送" class="headerlink" title="消息发送"></a><a href="https://juejin.im/entry/593779c52f301e006b26387d#消息发送" target="_blank" rel="noopener"></a>消息发送</h3><p>关于消息的发送，是通过 JMS 核心包中的<code>JmsTemplate</code>类来实现的，它简化了 JMS 的使用，因为在发送或同步接收消息时它帮我们处理了资源的创建和释放。从它的作用也不难推测出，它需要引用我们上面创建的连接工厂，具体代码如下：</p>
<pre><code>@Bean
public JmsTemplate jmsQueueTemplate(){

    return new JmsTemplate(connectionFactory());

}
</code></pre><p><code>JmsTemplate</code>创建完成后，我们就可以调用它的方法来发送消息了。这里有两个概念需要注意：</p>
<ol>
<li>消息会发送到哪里？-> 即需要指定发送队列的目的地（Destination），是可以在 JNDI 中进行存储和提取的 JMS 管理对象。</li>
<li>发送的消息体具体是什么？-> 实现了<code>javax.jms.Message</code>的对象，类似于 JAVA RMI 的 Remote 对象。</li>
</ol>
<p>代码示例：</p>
<pre><code>@Autowired
private JmsTemplate jmsQueueTemplate;

/**
 * 发送原始消息 Message
 */
public void send(){

    jmsQueueTemplate.send(&quot;queue1&quot;, new MessageCreator() {
        @Override
        public Message createMessage(Session session) throws JMSException {
            return session.createTextMessage(&quot;我是原始消息&quot;);
        }
    });

}
</code></pre><p>优化：当然，我们不用每次都通过<code>MessageCreator</code>匿名类的方式来创建<code>Message</code>对象，<code>JmsTemplate</code>类中提供了对象实体自动转换为<code>Message</code>对象的方法，<code>convertAndSend(String destinationName, final Object message)</code>。</p>
<p>优化代码示例：</p>
<pre><code>/**
 * 发送消息自动转换成原始消息
 */
public void convertAndSend(){

    jmsQueueTemplate.convertAndSend(&quot;queue1&quot;, &quot;我是自动转换的消息&quot;);

}
</code></pre><p><em>注：关于消息转换，还可以通过实现<code>MessageConverter</code>接口来自定义转换内容</em></p>
<h3 id="消息接收"><a href="#消息接收" class="headerlink" title="消息接收"></a><a href="https://juejin.im/entry/593779c52f301e006b26387d#消息接收" target="_blank" rel="noopener"></a>消息接收</h3><p>讲完了消息发送，我们最后来说说消息是如何接收的。消息既然是以<code>Message</code>对象的形式发送到指定的目的地，那么消息的接收势必会去指定的目的地上去接收消息。这里采用的是监听者的方式来监听指定地点的消息，采用注解<code>@JmsListener</code>来设置监听方法。</p>
<p>代码示例：</p>
<pre><code>@Component
public class Listener1 {

    @JmsListener(destination = &quot;queue1&quot;)
    public void receive(String msg){
        System.out.println(&quot;监听到的消息内容为: &quot; + msg);
    }

}
</code></pre><p>有了监听的目标和方法后，监听器还得和 MQ 关联起来，这样才能运作起来。这里的监听器可能不止一个，如果每个都要和 MQ 建立连接，肯定不太合适。所以需要一个监听容器工厂的概念，即接口<code>JmsListenerContainerFactory</code>，它会引用上面创建好的与 MQ 的连接工厂，由它来负责接收消息以及将消息分发给指定的监听器。当然也包括事务管理、资源获取与释放和异常转换等。</p>
<p>代码示例：</p>
<pre><code>@Bean
public DefaultJmsListenerContainerFactory jmsQueueListenerContainerFactory() {

    DefaultJmsListenerContainerFactory factory =
            new DefaultJmsListenerContainerFactory();
    factory.setConnectionFactory(connectionFactory());
    //设置连接数
    factory.setConcurrency(&quot;3-10&quot;);
    //重连间隔时间
    factory.setRecoveryInterval(1000L);
    return factory;

}
</code></pre><h2 id="场景"><a href="#场景" class="headerlink" title="场景"></a><a href="https://juejin.im/entry/593779c52f301e006b26387d#场景" target="_blank" rel="noopener"></a>场景</h2><p>代码地址：<a href="https://link.juejin.im/?target=https%3A%2F%2Fgithub.com%2FjasonGeng88%2Fspringboot-jms" target="_blank" rel="noopener">github.com/jasonGeng88…</a></p>
<p>对 JMS 有了基本的理解后，我们就来在具体的场景中使用一下。</p>
<p>首先，我们需要先启动 ActiveMQ，这里我们以 Docker 容器化的方式进行启动。</p>
<p>启动命令：</p>
<pre><code>docker run -d -p 8161:8161 -p 61616:61616 --name activemq webcenter/activemq
</code></pre><p>启动成功后，在 ActiveMQ 可视化界面查看效果（<a href="https://link.juejin.im/?target=http%3A%2F%2Flocalhost%3A8161%25EF%25BC%2589%25EF%25BC%259A" target="_blank" rel="noopener">http://localhost:8161）：</a></p>
<p><a href="https://link.juejin.im/?target=https%3A%2F%2Fgithub.com%2FjasonGeng88%2Fblog%2Fblob%2Fmaster%2F201706%2Fassets%2Fjms_activemq_01.png" target="_blank" rel="noopener"><img src="https://w.msla.top/wordpress/wp-content/uploads/2017/08/e3a21294e8f705a335492f74385aacd2.png" alt=""></a></p>
<h3 id="点对点模式（单消费者）"><a href="#点对点模式（单消费者）" class="headerlink" title="点对点模式（单消费者）"></a><a href="https://juejin.im/entry/593779c52f301e006b26387d#点对点模式单消费者" target="_blank" rel="noopener"></a>点对点模式（单消费者）</h3><p>下面介绍消息队列中最常用的一种场景，即点对点模式。基本概念如下：</p>
<ol>
<li>每个消息只能被一个消费者（Consumer）进行消费。一旦消息被消费后，就不再在消息队列中存在。</li>
<li>发送者和接收者之间在时间上没有依赖性，也就是说当发送者发送了消息之后，不管接收者有没有正在运行，它不会影响到消息被发送到队列。</li>
<li>接收者在成功接收消息之后需向队列应答成功。</li>
</ol>
<p><a href="https://link.juejin.im/?target=https%3A%2F%2Fgithub.com%2FjasonGeng88%2Fblog%2Fblob%2Fmaster%2F201706%2Fassets%2Fjms_01.png" target="_blank" rel="noopener"><img src="https://w.msla.top/wordpress/wp-content/uploads/2017/08/bcfa40557b7c26ceed5ae4a098874075.png" alt=""></a></p>
<h4 id="代码实现（为简化代码，部分代码沿用上面所述）："><a href="#代码实现（为简化代码，部分代码沿用上面所述）：" class="headerlink" title="代码实现（为简化代码，部分代码沿用上面所述）："></a><a href="https://juejin.im/entry/593779c52f301e006b26387d#代码实现为简化代码部分代码沿用上面所述" target="_blank" rel="noopener"></a>代码实现（为简化代码，部分代码沿用上面所述）：</h4><ul>
<li><p>启动文件（Application.java）</p>
<p>@SpringBootApplication<br>@EnableJms<br>public class Application {</p>
<pre><code>...

/**
 * JMS 队列的模板类
 * connectionFactory() 为 ActiveMQ 连接工厂
 */
@Bean
public JmsTemplate jmsQueueTemplate(){
    return new JmsTemplate(connectionFactory());
}

public static void main(String[] args) {
    SpringApplication.run(Application.class, args);
}
</code></pre><p>}</p>
</li>
</ul>
<p>注解<code>@EnableJms</code>设置在<code>@Configuration</code>类上，用来声明对 JMS 注解的支持。</p>
<ul>
<li><p>消息生产者（PtpProducer.java）</p>
<p>@Component<br>public class PtpProducer {</p>
<pre><code>@Autowired
private JmsTemplate jmsQueueTemplate;

/**
 * 发送消息自动转换成原始消息
 */
public void convertAndSend(){
    jmsQueueTemplate.convertAndSend(&quot;ptp&quot;, &quot;我是自动转换的消息&quot;);
}
</code></pre><p>}</p>
</li>
<li><p>生产者调用类（PtpController.java）</p>
<p>@RestController<br>@RequestMapping(value = “/ptp”)<br>public class PtpController {</p>
<pre><code>@Autowired
private PtpProducer ptpProducer;

@RequestMapping(value = &quot;/convertAndSend&quot;)
public Object convertAndSend(){
    ptpProducer.convertAndSend();
    return &quot;success&quot;;
}
</code></pre><p>}</p>
</li>
<li><p>消息监听容器工厂</p>
<p>@SpringBootApplication<br>@EnableJms<br>public class Application {</p>
<pre><code>...

/**
 * JMS 队列的监听容器工厂
 */
@Bean(name = &quot;jmsQueueListenerCF&quot;)
public DefaultJmsListenerContainerFactory jmsQueueListenerContainerFactory() {
    DefaultJmsListenerContainerFactory factory =
            new DefaultJmsListenerContainerFactory();
    factory.setConnectionFactory(connectionFactory());
    //设置连接数
    factory.setConcurrency(&quot;3-10&quot;);
    //重连间隔时间
    factory.setRecoveryInterval(1000L);
    return factory;
}
</code></pre><p>   …</p>
<p>}</p>
</li>
<li><p>消息监听器</p>
<p>@Component<br>public class PtpListener1 {</p>
<pre><code>/**
 * 消息队列监听器
 * destination 队列地址
 * containerFactory 监听器容器工厂, 若存在2个以上的监听容器工厂,需进行指定
 */
@JmsListener(destination = &quot;ptp&quot;, containerFactory = &quot;jmsQueueListenerCF&quot;)
public void receive(String msg){

    System.out.println(&quot;点对点模式1: &quot; + msg);

}
</code></pre><p>}</p>
</li>
</ul>
<h4 id="演示"><a href="#演示" class="headerlink" title="演示"></a><a href="https://juejin.im/entry/593779c52f301e006b26387d#演示" target="_blank" rel="noopener"></a>演示</h4><p>启动项目启动后，通过 REST 接口的方式来调用消息生产者发送消息，请求如下：</p>
<pre><code>curl -XGET 127.0.0.1:8080/ptp/convertAndSend
</code></pre><p>消费者控制台信息：</p>
<p><a href="https://link.juejin.im/?target=https%3A%2F%2Fgithub.com%2FjasonGeng88%2Fblog%2Fblob%2Fmaster%2F201706%2Fassets%2Fjms_ptp_01.png" target="_blank" rel="noopener"><img src="https://w.msla.top/wordpress/wp-content/uploads/2017/08/157e1fd796dc1a2e31b7aecf452840b0.png" alt=""></a></p>
<p>ActiveMQ 控制台信息：</p>
<p><a href="https://link.juejin.im/?target=https%3A%2F%2Fgithub.com%2FjasonGeng88%2Fblog%2Fblob%2Fmaster%2F201706%2Fassets%2Fjms_ptp_02.png" target="_blank" rel="noopener"><img src="https://w.msla.top/wordpress/wp-content/uploads/2017/08/abc579f226bb19a06b905c52098623e5.png" alt=""></a></p>
<p>列表说明：</p>
<ul>
<li>Name：队列名称。</li>
<li>Number Of Pending Messages：等待消费的消息个数。</li>
<li>Number Of Consumers：当前连接的消费者数目，因为我们采用的是连接池的方式连接，初始连接数为 3，所以显示数字为 3。</li>
<li>Messages Enqueued：进入队列的消息总个数，包括出队列的和待消费的，这个数量只增不减。</li>
<li>Messages Dequeued：出了队列的消息，可以理解为是已经消费的消息数量。</li>
</ul>
<h3 id="点对点模式（多消费者）"><a href="#点对点模式（多消费者）" class="headerlink" title="点对点模式（多消费者）"></a><a href="https://juejin.im/entry/593779c52f301e006b26387d#点对点模式多消费者" target="_blank" rel="noopener"></a>点对点模式（多消费者）</h3><p>基于上面一个消费者消费的模式，因为生产者可能会有很多，同时像某个队列发送消息，这时一个消费者可能会成为瓶颈。所以需要多个消费者来分摊消费压力（<em>消费线程池能解决一定压力，但毕竟在单机上，做不到分布式分布，所以多消费者是有必要的</em>），也就产生了下面的场景。</p>
<p><a href="https://link.juejin.im/?target=https%3A%2F%2Fgithub.com%2FjasonGeng88%2Fblog%2Fblob%2Fmaster%2F201706%2Fassets%2Fjms_02.png" target="_blank" rel="noopener"><img src="https://w.msla.top/wordpress/wp-content/uploads/2017/08/a055af89c98bf89fbf8a29d636cb3d7a.png" alt=""></a></p>
<h4 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a><a href="https://juejin.im/entry/593779c52f301e006b26387d#代码实现" target="_blank" rel="noopener"></a>代码实现</h4><ul>
<li><p>添加新的监听器</p>
<p>@Component<br>public class PtpListener2 {</p>
<pre><code>@JmsListener(destination = Constant.QUEUE_NAME, containerFactory = &quot;jmsQueueListenerCF&quot;)
public void receive(String msg){

    System.out.println(&quot;点对点模式2: &quot; + msg);

}
</code></pre><p>}</p>
</li>
</ul>
<h4 id="演示-1"><a href="#演示-1" class="headerlink" title="演示"></a><a href="https://juejin.im/entry/593779c52f301e006b26387d#演示-1" target="_blank" rel="noopener"></a>演示</h4><p>这里我们发起 10 次请求，来观察消费者的消费情况：</p>
<p><a href="https://link.juejin.im/?target=https%3A%2F%2Fgithub.com%2FjasonGeng88%2Fblog%2Fblob%2Fmaster%2F201706%2Fassets%2Fjms_ptp_03.png" target="_blank" rel="noopener"><img src="https://w.msla.top/wordpress/wp-content/uploads/2017/08/74f9480970a00736b85f72979a3e5c76.png" alt=""></a></p>
<p><em>这里因为监听容器设置了线程池的缘故，在实际消费过程中，监听器消费的顺序会有所差异。</em></p>
<h3 id="发布订阅模式"><a href="#发布订阅模式" class="headerlink" title="发布订阅模式"></a><a href="https://juejin.im/entry/593779c52f301e006b26387d#发布订阅模式" target="_blank" rel="noopener"></a>发布订阅模式</h3><p>除了点对点模式，发布订阅模式也是消息队列中常见的一种使用。试想一下，有一个即时聊天群，你在群里发送一条消息。所有在这个群里的人（即订阅了该群的人），都会收到你发送的信息。</p>
<p>基本概念：</p>
<ol>
<li>每个消息可以有多个消费者。</li>
<li>发布者和订阅者之间有时间上的依赖性。针对某个主题（Topic）的订阅者，它必须创建一个订阅者之后，才能消费发布者的消息。</li>
<li>为了消费消息，订阅者必须保持运行的状态。</li>
</ol>
<p><a href="https://link.juejin.im/?target=https%3A%2F%2Fgithub.com%2FjasonGeng88%2Fblog%2Fblob%2Fmaster%2F201706%2Fassets%2Fjms_03.png" target="_blank" rel="noopener"><img src="https://w.msla.top/wordpress/wp-content/uploads/2017/08/8ca746887c27d525656c4c043fa320c0.png" alt=""></a></p>
<h4 id="代码实现-1"><a href="#代码实现-1" class="headerlink" title="代码实现"></a><a href="https://juejin.im/entry/593779c52f301e006b26387d#代码实现-1" target="_blank" rel="noopener"></a>代码实现</h4><ul>
<li><p>修改 JmsTemplate 模板类，使其支持发布订阅功能</p>
<p>@SpringBootApplication<br>@EnableJms<br>public class Application {</p>
<pre><code>...

@Bean
public JmsTemplate jmsTopicTemplate(){
    JmsTemplate jmsTemplate = new JmsTemplate(connectionFactory());
    jmsTemplate.setPubSubDomain(true);
    return jmsTemplate;
}

...
</code></pre><p>}</p>
</li>
<li><p>消息生产者（PubSubProducer.java）</p>
<p>@Component<br>public class PtpProducer {</p>
<pre><code>@Autowired
private JmsTemplate jmsTopicTemplate;

public void convertAndSend(){
    jmsTopicTemplate.convertAndSend(&quot;topic&quot;, &quot;我是自动转换的消息&quot;);
}
</code></pre><p>}</p>
</li>
<li><p>生产者调用类（PubSubController.java）</p>
<p>@RestController<br>@RequestMapping(value = “/pubsub”)<br>public class PtpController {</p>
<pre><code>@Autowired
private PubSubProducer pubSubProducer;

@RequestMapping(value = &quot;/convertAndSend&quot;)
public String convertAndSend(){
    pubSubProducer.convertAndSend();
    return &quot;success&quot;;
}
</code></pre><p>}</p>
</li>
<li><p>修改 DefaultJmsListenerContainerFactory 类，使其支持发布订阅功能</p>
<p>@SpringBootApplication<br>@EnableJms<br>public class Application {</p>
<pre><code>...

/**
 * JMS 队列的监听容器工厂
 */
@Bean(name = &quot;jmsTopicListenerCF&quot;)
public DefaultJmsListenerContainerFactory jmsTopicListenerContainerFactory() {
    DefaultJmsListenerContainerFactory factory =
            new DefaultJmsListenerContainerFactory();
    factory.setConnectionFactory(connectionFactory());
    factory.setConcurrency(&quot;1&quot;);
    factory.setPubSubDomain(true);
    return factory;
}
</code></pre><p>   …</p>
<p>}</p>
</li>
<li><p>消息监听器（这里设置2个订阅者）</p>
<p>@Component<br>public class PubSubListener1 {</p>
<pre><code>@JmsListener(destination = &quot;topic&quot;, containerFactory = &quot;jmsTopicListenerCF&quot;)
public void receive(String msg){
    System.out.println(&quot;订阅者1 - &quot; + msg);
}
</code></pre><p>}</p>
<p>@Component<br>public class PubSubListener2 {</p>
<pre><code>@JmsListener(destination = &quot;topic&quot;, containerFactory = &quot;jmsTopicListenerCF&quot;)
public void receive(String msg){
    System.out.println(&quot;订阅者2 - &quot; + msg);
}
</code></pre><p>}</p>
</li>
</ul>
<h4 id="演示-2"><a href="#演示-2" class="headerlink" title="演示"></a><a href="https://juejin.im/entry/593779c52f301e006b26387d#演示-2" target="_blank" rel="noopener"></a>演示</h4><pre><code>curl -XGET 127.0.0.1:8080/pubSub/convertAndSend
</code></pre><p>消费者控制台信息：</p>
<p><a href="https://link.juejin.im/?target=https%3A%2F%2Fgithub.com%2FjasonGeng88%2Fblog%2Fblob%2Fmaster%2F201706%2Fassets%2Fjms_pubsub_01.png" target="_blank" rel="noopener"><img src="https://w.msla.top/wordpress/wp-content/uploads/2017/08/1368497530bd9cac60b9914930ec0fb5.png" alt=""></a></p>
<p>ActiveMQ 控制台信息：</p>
<p><a href="https://link.juejin.im/?target=https%3A%2F%2Fgithub.com%2FjasonGeng88%2Fblog%2Fblob%2Fmaster%2F201706%2Fassets%2Fjms_pubsub_02.png" target="_blank" rel="noopener"><img src="https://w.msla.top/wordpress/wp-content/uploads/2017/08/6b8245fdf6ea07a0638777f8f595350a.png" alt=""></a></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a><a href="https://juejin.im/entry/593779c52f301e006b26387d#总结" target="_blank" rel="noopener"></a>总结</h2><p>这里只是对 SpringBoot 与 JMS 集成的简单说明与使用，详细的介绍可以查看 Spring 的官方文档，我这里也有幸参与 并发编程网 发起的 Spring 5 的翻译工作，我主要翻译了 <a href="https://link.juejin.im/?target=http%3A%2F%2Fifeve.com%2Fspring-5-26-jms-java-message-service%2F" target="_blank" rel="noopener">Spring 5 的 JMS 章节</a>，其内容对于上述 JMS 的基本概念，都有详细的展开说明，有兴趣的可以看一下，当然翻译水平有限，英文好的建议看原文。</p>
<ul>
<li><a href="https://juejin.im/tag/Spring%20Boot" target="_blank" rel="noopener">Spring Boot</a><a href="https://juejin.im/tag/Java" target="_blank" rel="noopener">Java</a><a href="https://juejin.im/tag/%E5%90%8E%E7%AB%AF" target="_blank" rel="noopener">后端</a></li>
</ul>

          
        
      
    </div>

    

    
    
    

    

    
       
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://hero.triple.net.cn/2017/08/07/sentry-e5-bc-82-e5-b8-b8-e6-8d-95-e8-8e-b7/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="$$ Welcome $$">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Technician">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2017/08/07/sentry-e5-bc-82-e5-b8-b8-e6-8d-95-e8-8e-b7/" class="post-title-link" itemprop="https://hero.triple.net.cn/page/8/index.html">Sentry异常捕获</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2017-08-07 12:03:14" itemprop="dateCreated datePublished" datetime="2017-08-07T12:03:14+08:00">2017-08-07</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-12-12 17:27:29" itemprop="dateModified" datetime="2018-12-12T17:27:29+08:00">2018-12-12</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/技术分类/" itemprop="url" rel="index"><span itemprop="name">技术分类</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>简单点， Sentry注册： <a href="https://sentry.io" target="_blank" rel="noopener">https://sentry.io</a> 应用（PHP）：<a href="https://sentry.io/for/php/" target="_blank" rel="noopener">https://sentry.io/for/php/</a></p>
<hr>
<p><strong>安装</strong> 使用 composer 的方式 在项目根目录：</p>
<p>php composer.phar require “sentry/sentry”</p>
<p>完成之后会生成一个 vendor 目录，然后在你想调用的PHP文件中引用一下就可以了</p>
<p>require __DIR__ . ‘/vendor/autoload.php’;</p>
<p><strong>自动异常捕获示例：</strong> 这里使用 Redis 尝试连接一个不存在的host，以模拟真实环境中Redis挂掉的情况</p>
<pre><code>// 实例化（把URL改成你自己项目的）
$client = new Raven_Client(&apos;https://****:****@sentry.io/123456&apos;);
try {
    // ---------- 自动异常捕获 ------------
    $error_handler = new Raven_ErrorHandler($client);
    $error_handler-&gt;registerErrorHandler(true, E_ALL);
    // ---------- ENDS 自动异常捕获 ------------

    $redis = new Redis();
    $redis-&gt;connect(&quot;123.123.123.123&quot;, 6379, 1);
    $redis-&gt;set(&quot;Date&quot;, time());
} catch (Exception $exception) {
    $error_handler-&gt;registerExceptionHandler();
    $error_handler-&gt;registerShutdownFunction();
}
</code></pre><p><strong>手动捕获示例</strong></p>
<pre><code>//---------- 手动异常捕获 ------------
// Basic Reporting
$ex = new Exception(&quot;用户自定义异常，&quot; . date(DATE_RFC850));
$client-&gt;captureException($ex);

// Provide some additional data with an exception
$client-&gt;captureException($ex, array(
  &apos;extra&apos; =&gt; array(
    &apos;php_version&apos; =&gt; phpversion(),
    &apos;message&apos; =&gt; &quot;This will show users exception&quot;,
    &quot;something_els&quot; =&gt; &apos;Hello, &apos; . print_r($_SERVER, true),
  ),
));
// ---------- ENDS 手动异常捕获 ------------
</code></pre><p>Sentry 是一个开源的bug跟踪程序，可以在程序运行时捕捉异常，并通过邮件发送到相关人。 配置很简单，登陆到官网新建一个项目，选择好对应的框架或者语言，然后就会得到一个地址，用于在发生bug的时候向此地址报告错误 文档写的很详细，跟着做就好了</p>

          
        
      
    </div>

    

    
    
    

    

    
       
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://hero.triple.net.cn/2017/08/07/a-freebsd-11-desktop-how-to/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="$$ Welcome $$">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Technician">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2017/08/07/a-freebsd-11-desktop-how-to/" class="post-title-link" itemprop="https://hero.triple.net.cn/page/8/index.html">A FreeBSD 11 Desktop How-to</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2017-08-07 05:36:04" itemprop="dateCreated datePublished" datetime="2017-08-07T05:36:04+08:00">2017-08-07</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-12-12 16:58:16" itemprop="dateModified" datetime="2018-12-12T16:58:16+08:00">2018-12-12</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/操作系统/" itemprop="url" rel="index"><span itemprop="name">操作系统</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="A-FreeBSD-11-Desktop-How-to"><a href="#A-FreeBSD-11-Desktop-How-to" class="headerlink" title="A FreeBSD 11 Desktop How-to"></a>A FreeBSD 11 Desktop How-to</h1><p>FreeBSD is a fast, secure, modern <a href="https://en.wikipedia.org/wiki/Unix-like" target="_blank" rel="noopener">Unix-like</a> operating system with a fantastic community, great documentation, and powerful technologies like ZFS and LLVM. It’s my operating system of choice for everything from my i7-2600k desktop to my home router to my ARM plug computer jukebox. Though famed for its uptime in the datacenter the same OS is just as suited to desktop or laptop computing with a little work. Why use FreeBSD? Maybe I’m just getting old, but it’s nice to use an operating system that didn’t spawn a billion-dollar anti-malware industry through frequent security failings, where you can choose the interface you like and reasonably expect it to stay that way instead of being forced into the <a href="https://en.wikipedia.org/wiki/Windows_Aero" target="_blank" rel="noopener">design</a> <a href="https://en.wikipedia.org/wiki/Metro_%28design_language%29" target="_blank" rel="noopener">fad</a> <a href="https://en.wikipedia.org/wiki/Aqua_%28user_interface%29" target="_blank" rel="noopener">du</a> <a href="https://en.wikipedia.org/wiki/Brushed_Metal_%28interface%29" target="_blank" rel="noopener">jour</a>, where you don’t have to argue about the init system being replaced <a href="https://en.wikipedia.org/wiki/Upstart" target="_blank" rel="noopener">two</a> <a href="https://en.wikipedia.org/wiki/Systemd" target="_blank" rel="noopener">times</a> in the same decade, and whose key organizations don’t collectively <a href="https://lwn.net/Articles/500231/" target="_blank" rel="noopener">kowtow to Microsoft</a> when convenient. I’ve used many operating systems and have yet to find one more consistent and cohesive yet as well-supported as the BSD family, and FreeBSD is the one with the biggest community and most available drivers for things like graphics cards. “FreeBSD on the server, Linux on the desktop” is an oft-seen sentiment among some FreeBSD enthusiasts, and it’s sort of understandable considering the conservative out-of-the-box FreeBSD installation. Despite that, FreeBSD is just a few settings away from being an easy, powerful Desktop OS rivaling Linux, complete with the same software ecosystem available through the Ports collection. Unlike Linux where everything including the kernel is a package, FreeBSD is developed in a single source tree and released on a set schedule – twice a year – as a complete operating system on top of which you can install third-party software. The <a href="http://www.freebsd.org/releng/" target="_blank" rel="noopener">Release Engineering</a> page tracks the release history and schedule. Two major branches see releases in parallel, and major branches tend to live for two years (four minor versions) after their x.0 release. FreeBSD 11.x is currently the newest release branch with 10.x in maintenance mode and major development happening on 12.x. This guide attempts to show users with various hardware configurations the best way to configure a usable modern workstation running FreeBSD based on my own experience with Emi, my FreeBSD workstation. There are projects such as TrueOS and GhostBSD that can give you a good out-of-the-box desktop FreeBSD experience, but I find them disconnected from the underlying operating systems because they dump you into KDE or XFCE and attempt to hide as much of FreeBSD as possible behind graphical configuration. That’s not a bad thing, and I’m glad those projects exist, but this guide gets there in the other direction. You will install FreeBSD, learn how it works, and configure it into a great desktop. Compare this guide to something like <a href="http://www.linuxfromscratch.org/lfs/read.html" target="_blank" rel="noopener">Linux From Scratch</a> or a <a href="https://www.gentoo.org/doc/en/handbook/handbook-amd64.xml" target="_blank" rel="noopener">Gentoo installation</a> and you’ll see what a breeze this really is. Let’s do it!</p>
<h2 id="New-Installations"><a href="#New-Installations" class="headerlink" title="New Installations"></a>New Installations</h2><p>The <a href="http://www.freebsd.org/where.html" target="_blank" rel="noopener">Getting FreeBSD</a> page has links to ISOs for the six <a href="http://www.freebsd.org/doc/en_US.ISO8859-1/articles/committers-guide/archs.html#idp67604144" target="_blank" rel="noopener">tier 1</a> architectures. This guide focuses on amd64/i386 PCs though is broadly applicable to them all. The ISOs are available in <code>bootonly</code>, CD, DVD, and <code>memstick</code>. I usually grab the nearest &gt;1GB USB drive and <a href="http://www.freebsd.org/cgi/man.cgi?query=dd&amp;ektion=&amp;manpath=" title="man dd" target="_blank" rel="noopener">dd</a> the newest <code>memstick</code> image to it. The larger DVD images are available complete with Ports distribution files for those doing fully-offline installations. Boot the chosen installation media via whatever means your computer can (EFI boot menu, BIOS setting, fallback) and get ready to install. FreeBSD will boot to <a href="http://www.freebsd.org/doc/en_US.ISO8859-1/books/handbook/using-bsdinstall.html" target="_blank" rel="noopener">bsdinstall</a> and offer to Install, load an interactive rescue shell, or just boot normally off the installation disk. Choose <code>Install</code>, choose the keyboard mapping appropriate for your computer, and enter a hostname for your machine. When asked to choose system components I recommend selecting all of them. <code>doc</code> is useful to have locally if your Internet connection isn’t working, and system <code>src</code> is needed for some Ports to build and install.</p>
<h3 id="Disks"><a href="#Disks" class="headerlink" title="Disks"></a>Disks</h3><p>On the next screen, Partitioning, select either the <code>Auto (ZFS)</code> option or the <code>Auto (UFS)</code> option. UFS is the traditional <a href="https://en.wikipedia.org/wiki/Unix_File_System" target="_blank" rel="noopener">Unix file system</a> and is usable on any machine. It is fragile in the case of power loss or crashes unless journaled. <a href="https://en.wikipedia.org/wiki/ZFS" target="_blank" rel="noopener">ZFS</a>, on the other hand, is both a volume (pool) manager and a great filesystem. I strongly recommend ZFS for modern computers due to its resilience and rich feature set that makes it very practical for desktop use. It checksums your data constantly to ensure integrity and prevent silent corruption on-disk, and its copy-on-write model never overwrites blocks, eliminating the <a href="https://en.wikipedia.org/wiki/RAID#Atomicity:_including_parity_inconsistency_due_to_system_crashes" target="_blank" rel="noopener">RAID-5 write hole</a>. It supports snapshots, allowing you to snapshot a filesystem at an arbitrary point in time and roll back to it at will, like Apple’s Time Machine, and snapshots can be sent seamlessly across a network for incremental backups. It supports SSD cache devices to speed up reads and writes of pools backed by magnetic hard drives. It can deduplicate files, reducing the on-disk space for files that are significantly identical at the cost of lots of RAM. Achieving these features makes ZFS very memory-hungry. Plan to have 1GiB of physical memory for every 1TB of space in a zpool and much more if deduplication is used. ZFS can be <a href="https://wiki.freebsd.org/ZFSTuningGuide" target="_blank" rel="noopener">tuned</a> for tighter memory limitations, but very limited systems should use UFS instead. Most modern machines should not need to tune ZFS at all. It will use the memory available to it but also respond to memory pressure when other processes need RAM. Assuming you choose ZFS, set up your zpool. The pool can be a single disk (still called <code>stripe</code> but just striped with itself), a mirror, or any combination of disks in RAID-Z. Name the pool something. I usually name boot pools after the hostname of the machine and then data pools by function. The other ZFS options are dictated by your hardware. <img src="https://w.msla.top/wordpress/wp-content/uploads/2017/08/02bde3cb8e687908cbebb2c3d58bf5b7.png" alt=""> If you have an <a href="https://en.wikipedia.org/wiki/Advanced_Format" target="_blank" rel="noopener">Advanced Format</a> hard disk (any made in the last few years) or an SSD you should force 4k sectors. If your computer has a recent Intel or AMD CPU supporting <a href="https://en.wikipedia.org/wiki/AES_instruction_set" target="_blank" rel="noopener">AES instruction set</a> there is very little downside to encrypting your pool. I recommend it for any pool that doesn’t need to automatically mount at boot, i.e. I use encryption on my workstation but not on my FreeBSD router. Encrypting multiple physical devices with the same key will only require the passphrase once. You will be prompted for the passphrase while the kernel has loaded and is detecting hardware. On my system the passphrase prompt usually gets buried under my USB devices as the kernel enumerates them, so if you find yourself stuck there at boot hit a few keys and Enter to make the passphrase prompt reappear. Use <a href="https://en.wikipedia.org/wiki/GUID_Partition_Table" target="_blank" rel="noopener">GUID Partition Table</a> (GPT) if your computer uses EFI. PCs with BIOS most likely need to use a legacy <a href="https://en.wikipedia.org/wiki/Master_Boot_Record" target="_blank" rel="noopener">MBR</a>. GPT is a requirement to use disks over 2TB in size because MBR can address a maximum of 232 x 512 bytes, just larger than 2TB. The amount of swap space you use if any is dictated by the amount of memory in your computer and the loads you plan to place on it. Conventional wisdom says to use a swap size double the amount of physical memory in the machine, but I find that to apply less and less when you get up into double-digit gigabytes of RAM. My computer has 16GiB or physical memory and 8GiB of swap space defined. On some systems I don’t touch swap at all, but I recommend having at least some. You can enlarge it later.</p>
<h3 id="Finish"><a href="#Finish" class="headerlink" title="Finish"></a>Finish</h3><p>Once your disks are set up the installer will copy files and prompt you for the base configuration of things such root password, time zone, and network options. It will ask you to add at least one non-root user. When creating your personal user account be sure to invite it to the <code>wheel</code> and <code>operator</code> user groups. <code>wheel</code> membership is necessary to gain root privileges for administration tasks, and you will assign <code>operator</code> device permissions later in this guide. When prompted you can remove the install disk and reboot into your new system!</p>
<h2 id="Upgrading"><a href="#Upgrading" class="headerlink" title="Upgrading"></a>Upgrading</h2><p>Are you running a previous version already? The upgrade process is covered in full in <a href="http://www.freebsd.org/doc/en_US.ISO8859-1/books/handbook/updating-upgrading.html" target="_blank" rel="noopener">Chapter 24</a> of the Handbook, but assuming you are running the stock <code>GENERIC</code> kernel the process is very simple using <code>freebsd-update</code>. Check my <a href="https://cooltrainer.org/a-freebsd-desktop-howto/#upgrade-notes" target="_blank" rel="noopener">upgrade notes</a> section for specific version instructions. First, fetch the new system using <code>freebsd-update install</code> by specifying the <code>-r</code> argument. Without <code>-r</code> it will just fetch security and errata updates for your current minor version. You can upgrade to a new minor version in your current major or to a new major version entirely. If you’re upgrading to a new major version, go to the <code>.0</code> release first. Don’t upgrade from, say, <code>8.4-RELEASE</code> to <code>9.3-RELEASE</code>, but to <code>9.0-RELEASE</code> first and then to <code>9.3</code>.  </p>
<pre><code>freebsd-update upgrade -r 11.0-RELEASE
</code></pre><p><code>upgrade</code> is interactive and will ask you to confirm the system components it thinks you have installed. Once it fetches the updated system files you can begin the installation process.  </p>
<pre><code>freebsd-update install
</code></pre><p>This will install the new kernel but not any non-kernel OS components like userland executables. Reboot via <code>shutdown -r now</code>, <code>reboot</code>, or a swift kick to the power switch. When the system comes up, log in as root and install the new userland by re-running the install command.  </p>
<pre><code>freebsd-update install
</code></pre><p>At this point your OS itself is ready to go but your packages need to be updated to run on the new major version via your <a href="https://cooltrainer.org/a-freebsd-desktop-howto/#staying-up-to-date" target="_blank" rel="noopener">preferred method</a>, such as <code>pkg-static upgrade -f</code> for binary packages or<code>portupgrade`</code>, or<code>portmaster -af`</code> if you prefer to build ports. It is alternatively possible to maintain ABI compatibility with an older major version of FreeBSD by installing a compatibility library package such as <a href="http://freshports.org/misc/compat9x" title="misc/compat9x" target="_blank" rel="noopener">misc/compat9x</a>, but you shouldn’t unless you need it for a particular binary that isn’t available as source to build for the new version. Once that’s done you can run <code>freebsd-update install</code> one last time to chean out the shared libraries from the previous version. Reboot once more to your final updated system.</p>
<h2 id="First-Boot"><a href="#First-Boot" class="headerlink" title="First Boot"></a>First Boot</h2><p>Log in as root with the password you configured in the installer. Congratulations! You are now a FreeBSD user! The FreeBSD base system is a fully-featured operating system but as you can see does not contain a graphical environment or any third-party software like your typical Linux distribution. Before installing any of that you should configure your new system to be a better desktop. FreeBSD’s roots are in academia and the datacenter, so its default configuration is very conservative. The desktop or laptop computer you are most likely using is vastly more powerful than some of the configurations that will run FreeBSD, so there is room to grow without being unreasonable. You will need a text editor to edit configuration files. The base system ships with <a href="http://www.freebsd.org/cgi/man.cgi?query=vi&amp;ektion=&amp;manpath=" title="man vi" target="_blank" rel="noopener">vi</a> (not vim!) but for most users I would recommend <a href="http://www.freebsd.org/cgi/man.cgi?query=ee&amp;ektion=&amp;manpath=" title="man ee" target="_blank" rel="noopener">ee</a>. It’s part of the base system and is a simple but fully-featured editor like nano from the Linux world. If you aren’t happy with <code>ee</code> there are plenty of great editors you can install from Ports, like <a href="http://freshports.org/editors/vim" title="editors/vim" target="_blank" rel="noopener">editors/vim</a>, but let’s continue. If you aren’t entirely comfortable with editing config files you can re-access the graphical configuration screen from the installer by running <a href="http://www.freebsd.org/cgi/man.cgi?query=bsdconfig&amp;ektion=&amp;manpath=" title="man bsdconfig" target="_blank" rel="noopener">bsdconfig</a> as root, but I don’t think you’d be reading this page if that’s the case :)</p>
<h3 id="UTF-8"><a href="#UTF-8" class="headerlink" title="UTF-8"></a>UTF-8</h3><p>The <code>LANG=xx_YY.ZZZZ</code> <a href="https://en.wikipedia.org/wiki/Environment_variable" target="_blank" rel="noopener">environment variable</a> sets the system <a href="https://en.wikipedia.org/wiki/Locale" target="_blank" rel="noopener">locale</a> to language code <code>xx</code>, country code <code>YY</code>, and <a href="https://en.wikipedia.org/wiki/Character_encoding" target="_blank" rel="noopener">character encoding</a> <code>ZZZZ</code>. Language and country code affect default application language, number formatting, date and time formatting, string collation, currency settings, and more. By enabling a locale using UTF-8 character encoding, the system can understand and display each of the 1112064 characters in the <a href="https://en.wikipedia.org/wiki/Unicode" target="_blank" rel="noopener">Unicode character set</a>, instead of just US ASCII as is default with <code>LANG=C</code>. Check <code>locale -a | grep UTF-8</code> for a list of every available UTF-8 locale on your computer. As an American anglophone, I use <code>en_US.UTF-8</code>. Edit the login class capability database in /etc/<a href="http://www.freebsd.org/cgi/man.cgi?query=login.conf&amp;ektion=&amp;manpath=" title="man login.conf" target="_blank" rel="noopener">login.conf</a> to add a default character set and locale. Login shells will inherit the environment variables defined here in the <code>default</code> class or in a narrower class if it matches one. /etc/login.conf</p>
<pre><code>--- login.conf.default    2012-01-02 17:08:05.804291477 -0500
+++ login.conf    2012-01-02 17:08:16.996213774 -0500
@@ -44,7 +44,9 @@
     :pseudoterminals=unlimited:
     :priority=0:
     :ignoretime@:
-    :umask=022:
+    :umask=022:
+    :charset=UTF-8:
+    :lang=en_US.UTF-8:
</code></pre><p>Rebuild the login database with <code>cap_mkdb /etc/login.conf</code> after making changes. You may have to specify the new locale elsewhere (like <code>/etc/profile</code>) for non login shell uses such as GDM and other login managers. /etc/profile</p>
<pre><code>LANG=en_US.UTF-8;   export LANG
CHARSET=UTF-8;  export CHARSET
</code></pre><p>You can read more in the <a href="http://www.freebsd.org/doc/en_US.ISO8859-1/books/handbook/using-localization.html" target="_blank" rel="noopener">Using Localization</a> chapter of the Handbook. Check your work by running <a href="http://www.freebsd.org/cgi/man.cgi?query=locale&amp;ektion=&amp;manpath=" title="man locale" target="_blank" rel="noopener">locale</a> on your next login. locale</p>
<pre><code>LANG=en_US.UTF-8
LC_CTYPE=&quot;en_US.UTF-8&quot;
LC_COLLATE=&quot;en_US.UTF-8&quot;
LC_TIME=&quot;en_US.UTF-8&quot;
LC_NUMERIC=&quot;en_US.UTF-8&quot;
LC_MONETARY=&quot;en_US.UTF-8&quot;
LC_MESSAGES=&quot;en_US.UTF-8&quot;
LC_ALL=en_US.UTF-8
</code></pre><h3 id="Tuning-and-drivers"><a href="#Tuning-and-drivers" class="headerlink" title="Tuning and drivers"></a>Tuning and drivers</h3><p>Change a few <a href="http://www.freebsd.org/cgi/man.cgi?query=sysctl&amp;ektion=&amp;manpath=" title="man sysctl" target="_blank" rel="noopener">sysctl</a> variables to enhance the experience of FreeBSD on the desktop, including expanding the amount of shared memory, tuning the <a href="http://www.freebsd.org/cgi/man.cgi?query=sched_ule&amp;ektion=4&amp;manpath=FreeBSD%2011.0-RELEASE" title="man sched_ule from FreeBSD 11.0-RELEASE" target="_blank" rel="noopener">process scheduler</a> for desktop use, and increasing the limit of simultaneously-open files to something sensible. /etc/sysctl.conf</p>
<pre><code># Enhance shared memory X11 interface
kern.ipc.shmmax=67108864
kern.ipc.shmall=32768

# Enhance desktop responsiveness under high CPU use (200/224)
kern.sched.preempt_thresh=224

# Bump up maximum number of open files
kern.maxfiles=200000

# Disable PC Speaker
hw.syscons.bell=0

# Shared memory for Chromium
kern.ipc.shm_allow_removed=1
</code></pre><p>Some knobs can only be set at boot by the <a href="http://www.freebsd.org/cgi/man.cgi?query=loader&amp;ektion=&amp;manpath=" title="man loader" target="_blank" rel="noopener">loader</a> by setting them in <code>/boot/loader.conf</code>. This is also where we define kernel modules to load at boot. /boot/loader.conf</p>
<pre><code># Devil worship in loader logo
loader_logo=&quot;beastie&quot;

# Boot-time kernel tuning
kern.ipc.shmseg=1024
kern.ipc.shmmni=1024
kern.maxproc=100000

# Load MMC/SD card-reader support
mmc_load=&quot;YES&quot;
mmcsd_load=&quot;YES&quot;
sdhci_load=&quot;YES&quot;

# Access ATAPI devices through the CAM subsystem
atapicam_load=&quot;YES&quot;

# Filesystems in Userspace
fuse_load=&quot;YES&quot;

# Intel Core thermal sensors
coretemp_load=&quot;YES&quot;

# AMD K8, K10, K11 thermal sensors
amdtemp_load=&quot;YES&quot;

# In-memory filesystems
tmpfs_load=&quot;YES&quot;

# Asynchronous I/O
aio_load=&quot;YES&quot;

# Handle Unicode on removable media
libiconv_load=&quot;YES&quot;
libmchain_load=&quot;YES&quot;
cd9660_iconv_load=&quot;YES&quot;
msdosfs_iconv_load=&quot;YES&quot;
</code></pre><p>Finally, enable everything else. /etc/rc.conf</p>
<pre><code>moused_enable=&quot;YES&quot;

# powerd: hiadaptive speed while on AC power, adaptive while on battery power
powerd_enable=&quot;YES&quot;
powerd_flags=&quot;-a hiadaptive -b adaptive&quot;

# Enable BlueTooth
hcsecd_enable=&quot;YES&quot;
sdpd_enable=&quot;YES&quot;

# Synchronize system time
ntpd_enable=&quot;YES&quot;
# Let ntpd make time jumps larger than 1000sec
ntpd_flags=&quot;-g&quot;
</code></pre><p>Enable remote access via SSH if you plan to use it. Otherwise, there’s no need to expose your system. /etc/rc.conf</p>
<pre><code># Remote logins
sshd_enable=&quot;YES&quot;
</code></pre><h3 id="Mounts"><a href="#Mounts" class="headerlink" title="Mounts"></a>Mounts</h3><p>The <a href="http://www.freebsd.org/cgi/man.cgi?query=procfs&amp;ektion=&amp;manpath=" title="man procfs" target="_blank" rel="noopener">procfs</a> and <a href="http://www.freebsd.org/cgi/man.cgi?query=fdescfs&amp;ektion=&amp;manpath=" title="man fdescfs" target="_blank" rel="noopener">fdescfs</a> virtual filesystems are not a default part of BSD but are frequently required for compatibility with programs and environments written with Linux in mind, such as GNOME/MATE and KDE. The FreeBSD equivalent is <a href="http://www.freebsd.org/cgi/man.cgi?query=sysctl&amp;ektion=&amp;manpath=" title="man sysctl" target="_blank" rel="noopener">sysctl</a>, but you can mount <code>/proc</code> too if you plan to use software requiring it. Some special filesystems like <code>fdescfs</code> must be mounted <code>late</code> on ZFS-rooted systems since the location of their mountpoint won’t exist until late in the boot process. /etc/fstab</p>
<pre><code>proc    /proc    procfs    rw    0    0
fdesc    /dev/fd    fdescfs    rw,auto,late    0    0
</code></pre><p>Toggle the sysctl that lets users mount disks. /etc/sysctl.conf</p>
<pre><code># Allow users to mount disks
vfs.usermount=1
</code></pre><p>If you neglected to add your personal user account to the <code>wheel</code> and <code>operator</code> groups at creation, now is a good time to do so. <code>wheel</code> membership lets you use <a href="http://www.freebsd.org/cgi/man.cgi?query=su&amp;ektion=&amp;manpath=" title="man su" target="_blank" rel="noopener">su</a> to become root, and <code>operator</code> membership is required for device permissions in this configuration. In this example my user is <code>okeeblow</code>. Substitute it for yours.  </p>
<pre><code>pw usermod okeeblow -G wheel
pw usermod okeeblow -G operator
</code></pre><h3 id="Device-Permissions"><a href="#Device-Permissions" class="headerlink" title="Device Permissions"></a>Device Permissions</h3><p>Relax default permissions on the <a href="http://www.freebsd.org/cgi/man.cgi?query=devfs&amp;ektion=&amp;manpath=FreeBSD%2011.0-RELEASE" title="man devfs from FreeBSD 11.0-RELEASE" target="_blank" rel="noopener">device filesystem</a> to allow normal users access to a variety of disks and input/output devices. Permissions for devices existing at boot time are set in <a href="http://www.freebsd.org/cgi/man.cgi?query=devfs.conf&amp;ektion=&amp;manpath=" title="man devfs.conf" target="_blank" rel="noopener">devfs.conf</a>. Each line defines a full device path and octal permission value. /etc/devfs.conf</p>
<pre><code># Allow all users to access optical media
perm    /dev/acd0       0666
perm    /dev/acd1       0666
perm    /dev/cd0        0666
perm    /dev/cd1        0666

# Allow all USB Devices to be mounted
perm    /dev/da0        0666
perm    /dev/da1        0666
perm    /dev/da2        0666
perm    /dev/da3        0666
perm    /dev/da4        0666
perm    /dev/da5        0666

# Misc other devices
perm    /dev/pass0      0666
perm    /dev/xpt0       0666
perm    /dev/uscanner0  0666
perm    /dev/video0     0666
perm    /dev/tuner0     0666
perm    /dev/dvb/adapter0/demux0    0666
perm    /dev/dvb/adapter0/dvr       0666
perm    /dev/dvb/adapter0/frontend0 0666
</code></pre><p>For devices that may be connected post-boot, we add an entry to a <a href="http://www.freebsd.org/cgi/man.cgi?query=devfs.rules&amp;ektion=&amp;manpath=" title="man devfs.rules" target="_blank" rel="noopener">devfs.rules</a> ruleset. Rulesets must have a unique name and number, and their rules are composed of a path or quoted path <a href="https://en.wikipedia.org/wiki/Glob_%28programming%29" target="_blank" rel="noopener">glob</a> and octal permission value. /etc/devfs.rules</p>
<pre><code>[devfsrules_common=7]
add path &apos;ad[0-9]*&apos;        mode 666
add path &apos;ada[0-9]*&apos;    mode 666
add path &apos;da[0-9]*&apos;        mode 666
add path &apos;acd[0-9]*&apos;    mode 666
add path &apos;cd[0-9]*&apos;        mode 666
add path &apos;mmcsd[0-9]*&apos;    mode 666
add path &apos;pass[0-9]*&apos;    mode 666
add path &apos;xpt[0-9]*&apos;    mode 666
add path &apos;ugen[0-9]*&apos;    mode 666
add path &apos;usbctl&apos;        mode 666
add path &apos;usb/*&apos;        mode 666
add path &apos;lpt[0-9]*&apos;    mode 666
add path &apos;ulpt[0-9]*&apos;    mode 666
add path &apos;unlpt[0-9]*&apos;    mode 666
add path &apos;fd[0-9]*&apos;        mode 666
add path &apos;uscan[0-9]*&apos;    mode 666
add path &apos;video[0-9]*&apos;    mode 666
add path &apos;tuner[0-9]*&apos;  mode 666
add path &apos;dvb/*&apos;        mode 666
add path &apos;cx88*&apos; mode 0660
add path &apos;cx23885*&apos; mode 0660 # CX23885-family stream configuration device
add path &apos;iicdev*&apos; mode 0660
add path &apos;uvisor[0-9]*&apos; mode 0660
</code></pre><p>Enable our new ruleset. /etc/rc.conf</p>
<pre><code>devfs_system_ruleset=&quot;devfsrules_common&quot;
</code></pre><h3 id="Sound"><a href="#Sound" class="headerlink" title="Sound"></a>Sound</h3><p>Enable sound support at boot in loader.conf, and load it immediately with <code>kldload snd_driver</code>.  </p>
<pre><code>echo &apos;snd_driver_load=&quot;YES&quot;&apos; &gt;&gt; /boot/loader.conf
</code></pre><p>Then, <code>cat /dev/sndstat</code> to see your available devices. cat /dev/sndstat</p>
<pre><code>FreeBSD Audio Driver (newpcm: 64bit 2009061500/amd64)
Installed devices:
pcm0: &lt;HDA NVidia (Unknown) PCM #0 DisplayPort&gt; (play)
pcm1: &lt;HDA NVidia (Unknown) PCM #0 DisplayPort&gt; (play)
pcm2: &lt;HDA NVidia (Unknown) PCM #0 DisplayPort&gt; (play)
pcm3: &lt;HDA NVidia (Unknown) PCM #0 DisplayPort&gt; (play)
pcm4: &lt;HDA Realtek ALC892 PCM #0 Analog&gt; (play/rec)
pcm5: &lt;HDA Realtek ALC892 PCM #1 Analog&gt; (play/rec)
pcm6: &lt;HDA Realtek ALC892 PCM #2 Digital&gt; (play)
pcm7: &lt;HDA Realtek ALC892 PCM #3 Digital&gt; (play)
pcm8: &lt;USB audio&gt; (play) default
pcm9: &lt;USB audio&gt; (rec)
</code></pre><p>The <code>hw.snd.default_unit</code> sysctl variable controls the default audio output. I want to use the S/PDIF output of my onboard Realtek audio, <code>pcm6</code>, so I set <code>hw.snd.default_unit</code> to <code>6</code>. Enabling the <code>hw.snd.default_auto</code> boolean will automatically assign <code>hw.snd.default_unit</code> to newly-attached devices. /etc/sysctl.conf</p>
<pre><code># S/PDIF out on my MSI board
hw.snd.default_unit=6

# Don&apos;t automatically use new sound devices
hw.snd.default_auto=0
</code></pre><h2 id="Networking"><a href="#Networking" class="headerlink" title="Networking"></a>Networking</h2><p>If you didn’t enable networking during the install process now is a good time to do so. Here as an example is my computer, <code>emi</code>, a desktop with a wired network. I have a Realtek interface, <code>re0</code>. The name of your interface may vary based on the driver it uses. Most drivers are built into the <code>GENERIC</code> kernel, so your interface should be visible by running <code>ifconfig</code>. Common drivers you may see include <a href="http://www.freebsd.org/cgi/man.cgi?query=if_em&amp;ektion=&amp;manpath=" title="man if_em" target="_blank" rel="noopener">if_em</a> for Intel PRO interfaces, <a href="http://www.freebsd.org/cgi/man.cgi?query=if_re&amp;ektion=&amp;manpath=" title="man if_re" target="_blank" rel="noopener">if_re</a> for Realtek interfaces, and <a href="http://www.freebsd.org/cgi/man.cgi?query=if_en&amp;ektion=&amp;manpath=" title="man if_en" target="_blank" rel="noopener">if_en</a> for Midway interfaces. Read more about network configuration <a href="http://www.freebsd.org/doc/en_US.ISO8859-1/books/handbook/config-network-setup.html" target="_blank" rel="noopener">in the Handbook</a> to learn about other possible configurations.</p>
<h3 id="Wired"><a href="#Wired" class="headerlink" title="Wired"></a>Wired</h3><p>You can use DHCP and SLAAC auto-discovery on most home networks: /etc/rc.conf</p>
<pre><code>hostname=&quot;emi.aloe.cooltrainer.org&quot;

# Enable DHCP for re0 and don&apos;t let dhclient block
background_dhclient=&quot;YES&quot;
ifconfig_re0=&quot;DHCP&quot;
ifconfig_re0_ipv6=&quot;inet6 accept_rtadv&quot;
</code></pre><p>You can bring up the interface and get a DHCP address immediately by issuing <code>ifconfig re0 up</code> and <code>dhclient re0</code>, again substituting the name of your own interface. Alternatively, you can supply static network addresses for your computer and default router: /etc/rc.conf</p>
<pre><code>hostname=&quot;emi.aloe.cooltrainer.org&quot;

ifconfig_re0=&quot;inet 172.16.0.40 netmask 255.240.0.0 broadcast 172.31.255.255&quot;
defaultrouter=&quot;172.16.0.1&quot;

ifconfig_re0_ipv6=&quot;inet6 2001:370:10f5:806::40 prefixlen 64&quot;
ipv6_defaultrouter=&quot;2001:370:10f5:806::1&quot;
</code></pre><h3 id="Wireless"><a href="#Wireless" class="headerlink" title="Wireless"></a>Wireless</h3><p>For WiFi configuration, see the <a href="http://www.freebsd.org/doc/en_US.ISO8859-1/books/handbook/network-wireless.html" target="_blank" rel="noopener">wireless networking</a> section of the Handbook. I sometimes tether my desktop to my Android phone using a <a href="http://www.freebsd.org/cgi/man.cgi?query=run&amp;ektion=&amp;manpath=" title="man run" target="_blank" rel="noopener">run</a> B/G USB interface. It’s as simple as defining a new virtual <code>wlan</code> interface on <code>run0</code>, configuring <a href="http://www.freebsd.org/cgi/man.cgi?query=wpa_supplicant&amp;ektion=&amp;manpath=" title="man wpa_supplicant" target="_blank" rel="noopener">wpa_supplicant</a> for the WPA pre-shared key, and specifying the SSID and encryption standard (WPA). /etc/rc.conf</p>
<pre><code>wlans_run0=&quot;wlan0&quot;
ifconfig_wlan0=&quot;ssid Doubleshot WPA DHCP&quot;
</code></pre><p>/etc/wpa_supplicant.conf</p>
<pre><code>network={
    ssid=&quot;Doubleshot&quot;
    psk=&quot;pantsupantsu&quot;
}
</code></pre><h3 id="IPv6"><a href="#IPv6" class="headerlink" title="IPv6"></a>IPv6</h3><p>My configuration examples cover both IPv4 and IPv6 because I have a dual-stacked network. Depending on your network you may prefer to enable and prefer IPv6 like me, enable it but prefer IPv4, or not enable it at all. This can be done in rc.conf: /etc/rc.conf</p>
<pre><code>ipv6_activate_all_interfaces=&quot;YES&quot;
ip6addrctl_policy=&quot;ipv6_prefer&quot;
</code></pre><p>/etc/sysctl.conf</p>
<pre><code># Accept IPv6 router advertisements
net.inet6.ip6.accept_rtadv=1
</code></pre><h3 id="Firewall"><a href="#Firewall" class="headerlink" title="Firewall"></a>Firewall</h3><p>You should run a firewall. Windows, OS X, and many Linux distributions ship with a default firewall ruleset. FreeBSD does not, because there is no one-size-fits-all firewall configuration, but it does include one of the best software firewalls in the world, <a href="http://www.freebsd.org/doc/handbook/firewalls-pf.html" target="_blank" rel="noopener">PF</a>, courtesy of the OpenBSD project. Configuring a firewall can be a very complex topic. There are <a href="http://www.amazon.com/The-Book-PF-No-Nonsense-Firewall/dp/159327274X" target="_blank" rel="noopener">entire books</a> on the matter. Shown here is the ruleset from my computer. It has rules for a single network interface defined at the top of the file in the <code>ext_if</code> macro. Change it to the name of your computer’s interface as seen in <code>ifconfig</code>. The macros on the next few lines define the TCP and UDP ports on which this ruleset will allow incoming connections. My computer runs an SSH server on the default port, runs <a href="http://freshports.org/www/subsonic" title="www/subsonic" target="_blank" rel="noopener">www/subsonic</a> on port 443 (HTTPS), and has control ports for <a href="http://freshports.org/net/mosh" title="net/mosh" target="_blank" rel="noopener">net/mosh</a> in the 60000 range. You can open ports for additional services by defining them in those macros. The named services like <code>ssh</code> are defined in /etc/<a href="http://www.freebsd.org/cgi/man.cgi?query=services&amp;ektion=&amp;manpath=" title="man services" target="_blank" rel="noopener">services</a>. /etc/pf.conf</p>
<pre><code># The name of our network interface as seen in `ifconfig`
ext_if=&quot;re0&quot;

# Macros to define the set of TCP and UDP ports to open.
# Add additional ports or ranges separated by commas.
# UDP 60000-60010 is mosh control http://mosh.mit.edu/
tcp_services = &quot;{ssh, https}&quot;
udp_services = &quot;{60000:60010}&quot;

# If you block all ICMP requests you will break things like path MTU
# discovery. These macros define allowed ICMP types. The additional
# ICMPv6 types are for neighbor discovery (RFC 4861)
icmp_types = &quot;{echoreq, unreach}&quot;
icmp6_types=&quot;{echoreq, unreach, 133, 134, 135, 136, 137}&quot;

# Modulate the initial sequence number of TCP packets.
# Broken operating systems sometimes don&apos;t randomize this number,
# making it guessable.
tcp_state=&quot;flags S/SA keep state&quot;
udp_state=&quot;keep state&quot;

# Don&apos;t send rejections. Just drop.
set block-policy drop

# Exempt the loopback interface to prevent services utilizing the
# local loop from being blocked accidentally.
set skip on lo0

# all incoming traffic on external interface is normalized and fragmented
# packets are reassembled.
scrub in on $ext_if all fragment reassemble

# set a default deny policy.
block in log all

# This is a desktop so be permissive in allowing outgoing connections.
pass out quick modulate state

# Enable antispoofing on the external interface
antispoof for $ext_if inet
antispoof for $ext_if inet6

# block packets that fail a reverse path check. we look up the routing
# table, check to make sure that the outbound is the same as the source
# it came in on. if not, it is probably source address spoofed.
block in from urpf-failed to any

# drop broadcast requests quietly.
block in quick on $ext_if from any to 255.255.255.255

# Allow the services defined in the macros at the top of the file
pass in on $ext_if inet proto tcp from any to any port $tcp_services $tcp_state
pass in on $ext_if inet6 proto tcp from any to any port $tcp_services $tcp_state

pass in on $ext_if inet proto udp from any to any port $udp_services $udp_state
pass in on $ext_if inet6 proto udp from any to any port $udp_services $udp_state

# Allow ICMP
pass inet proto icmp all icmp-type $icmp_types keep state
pass inet6 proto icmp6 all icmp6-type $icmp6_types keep state
</code></pre><p>Enable the firewall in rc.conf and start it now.  </p>
<pre><code>echo &apos;pf_enable=&quot;YES&quot;&apos; &gt;&gt; /etc/rc.conf
service pf start
</code></pre><p>After making changes to your ruleset you can check them for validity and load the new rules with <a href="http://www.freebsd.org/cgi/man.cgi?query=pfctl&amp;ektion=&amp;manpath=" title="man pfctl" target="_blank" rel="noopener">pfctl</a>. It will abort if your ruleset contains an error unlike <code>service pf restart</code> which will stop, fail to start due to the error, and leave you locked out of SSH. Ask me how I know this will happen.  </p>
<pre><code>pfctl -f /etc/pf.conf
</code></pre><h2 id="Installing-Software"><a href="#Installing-Software" class="headerlink" title="Installing Software"></a>Installing Software</h2><p>FreeBSD is historically famous for its <a href="http://www.freebsd.org/doc/en_US.ISO8859-1/books/handbook/ports-using.html#PORTS-SKELETON" target="_blank" rel="noopener">Ports Collection</a>, a directory skeleton of <code>Makefile</code>s and patches describing how to programmatically build packages of third-party software for your computer. Each port contains the metadata for that piece of software including the filename of the source archive, <a href="http://www.freebsd.org/cgi/man.cgi?query=sha256&amp;ektion=&amp;manpath=" title="man sha256" target="_blank" rel="noopener">sha256</a> hash of the files, what other software dependencies it requires, what compile-time options are available, what files it installs, and any patches necessary to work around non-portable code or fix issues that can’t be upstreamed to the projects themselves. Every port has a maintainer whose job it is to keep the port up to date and respond to issues if they arise with newer versions of the operating system. For example, check out <a href="http://www.freshports.org/search.php?stype=maintainer&amp;method=exact&amp;query=root@cooltrainer.org" target="_blank" rel="noopener">the ports I maintain</a>! When you <code>make</code> a port in the Ports Collection it downloads the upstream source archive, patches it, configures it, builds a customized binary package, and uses FreeBSD’s underlying binary package manager to install it. Third-party software installed through the package manager ends up in <code>/usr/local</code> where it mirrors the hierarchy of <code>/usr</code>. It might seem confusing to have them in two places, but it gives a fairly clean separation of the base system from the packages. For example, <code>/usr/local/bin</code> is where you will find <code>firefox</code> after installing <a href="http://freshports.org/www/firefox" title="www/firefox" target="_blank" rel="noopener">www/firefox</a>, but <code>/usr/bin</code> is where you will find <code>ee</code> or <code>sed</code>. As you have experienced, configuration for the operating system is done in <code>/etc</code>. Configuration files for your ports will usually be in <code>/usr/local/etc</code>. Check the <a href="http://www.freebsd.org/cgi/man.cgi?query=hier&amp;ektion=&amp;manpath=" title="man hier" target="_blank" rel="noopener">hier</a> manual for the full layout. As of FreeBSD 10 there is a new binary package manager, known as <code>pkgng</code> or just <a href="http://www.freebsd.org/doc/en_US.ISO8859-1/books/handbook/pkgng-intro.html" target="_blank" rel="noopener">pkg</a>. It replaces the old suite of <code>pkg_</code> tools such as <code>pkg_add</code> and <code>pkg_delete</code> and contains many advanced features that have been missing from FreeBSD for years. Compared to the old package manager, pkgng supports safe upgrades (meaning it saves a copy of the previous-version package to roll back in case of failure), multiple repositories, package staging before install, a more modern binary package format, a more robust sqlite-based package registration database, and most importantly remote binary package upgrades. Thanks to pkgng it is now possible to add multiple remote binary package repositories and get updates from them without relying on building Ports at all. The FreeBSD project provide binary packages built from the Ports tree using the default options. For example, installing a binary package of Firefox with <code>pkg install firefox</code> or <code>pkg install www/firefox</code> is equivalent to doing <code>portsnap fetch extract &amp;&amp; cd /usr/local/www/firefox &amp;&amp; make install</code>. I will stick to the convention of <code>pkg install</code> on this page but the names will be identical if you prefer to build customized packages from Ports. It is possible to mix and match binary packages with your own custom packages built from Ports using pkg’s <code>lock</code> and <code>unlock</code>, but that gets more advanced and more annoying than is appropriate for this guide. I build my ports on one of my computers using <a href="https://fossil.etoilebsd.net/poudriere/doc/trunk/doc/index.wiki" target="_blank" rel="noopener">poudriere</a> then use that computer as a binary package repository for the other FreeBSD computers on my network. A new user with just one computer should stick to <code>pkg install</code> from the default package server until they are more familiar with the OS. In the past I recommended building Ports over the default binary package server due to some strange default port options and the lack of package coverage for certain software like KDE. These days however I recommend using binary packages by default unless you find a particular port option you absolutely must have. Even then, consider using poudriere to create a local package server instead of building and installing ports the traditional way. It’s more work initially to set up but saves you from the hassle of updating shared libraries while trying to use your computer. The old fashioned way will replace <code>libfoo.so.4</code> with <code>libfoo.so.5</code> and only then start rebuilding ports that depend on it. Meanwhile your currently-installed software will be unusable due to the missing <code>libfoo.so.4</code>. Packages avoid this issue and alert you upfront to any build failures. Probably 99% of users these days will be fine with the packages provided by the FreeBSD project. No matter the route you choose, you should begin by updating your pkg repository or your Ports tree. <code>pkg update</code> will fetch an updated index from every <code>PACKAGESITE</code> defined in that environment variable or in <code>pkg.conf</code>. For Ports, <code>portsnap fetch extract</code> will retrieve a new full ports tree. You should read <a href="http://www.freebsd.org/cgi/man.cgi?query=pkg&amp;ektion=&amp;manpath=" title="man pkg" target="_blank" rel="noopener">pkg</a> for the list of commands supported by <code>pkg</code> and read <a href="http://www.freebsd.org/cgi/man.cgi?query=ports&amp;ektion=&amp;manpath=" title="man ports" target="_blank" rel="noopener">ports</a> for the list of available <code>make</code> targets in Ports, but in general you will use <code>pkg install &lt;portname&gt;</code> (or <code>pkg install &lt;category&gt;/&lt;portname&gt;</code>) or <code>cd /usr/ports/&lt;category&gt;/&lt;portname&gt; &amp;&amp; make install</code> to install software. If you choose to build your own packages from Ports it will be because you want to customize options, so use <code>make config-recursive</code> in any port’s directory to set these port options in advance so they don’t continually interrupt the build. Read over the options as they are presented, but generally don’t toggle an option if you don’t know what it does. The defaults are default for a reason! Once you’ve chosen all the options, run <code>make config-recursive</code> again, since it’s likely for a dependency enabled the first time to have options of its own. When no further port options are displayed run <code>make install</code> to compile and install your custom package. The first things I usually install on a new system are <a href="http://freshports.org/sysutils/tmux" title="sysutils/tmux" target="_blank" rel="noopener">sysutils/tmux</a> and <a href="http://freshports.org/shells/zsh" title="shells/zsh" target="_blank" rel="noopener">shells/zsh</a> because I prefer it to the venerable default <a href="http://www.freebsd.org/cgi/man.cgi?query=tcsh&amp;ektion=&amp;manpath=" title="man tcsh" target="_blank" rel="noopener">tcsh</a>. You might be more comfortable with <a href="http://freshports.org/shells/bash" title="shells/bash" target="_blank" rel="noopener">shells/bash</a>. Once installed, changing your user’s default shell is as simple as <code>chsh -s /usr/local/bin/zsh</code>.</p>
<h3 id="Build-Settings"><a href="#Build-Settings" class="headerlink" title="Build Settings"></a>Build Settings</h3><p>Some third-party software options can only be set at compile time. Here are a few you should consider for desktop use if you decide to build your own customized packages. The <a href="https://qt-project.org/" target="_blank" rel="noopener">Qt</a> toolkit has some options that can be set via any combination of the following knobs. If you change the <code>QT4_OPTIONS</code> after Qt is installed you will need to rebuild <a href="http://freshports.org/devel/qt4-corelib" title="devel/qt4-corelib" target="_blank" rel="noopener">devel/qt4-corelib</a> and <a href="http://freshports.org/x11-toolkits/qt4-gui" title="x11-toolkits/qt4-gui" target="_blank" rel="noopener">x11-toolkits/qt4-gui</a>.</p>
<ul>
<li><a href="http://blog.qt.digia.com/blog/2008/05/13/introducing-qgtkstyle/" target="_blank" rel="noopener">QGtkStyle</a> is a selectable theme engine that lets Qt applications integrate more closely with <a href="http://www.gtk.org/" target="_blank" rel="noopener">GTK+</a> environments and can be enabled with the <code>QGTKSTYLE</code> Qt4 option. You should enable this option if you plan to use a GTK+-based desktop environment like MATE or XFCE. Once built you can select the GTK+ visual style in <code>qt4-qtconfig</code>.</li>
<li>CUPS is the standard printing engine on Free Unix-like systems. Support for it in Qt can be enabled with the <code>CUPS</code> Qt4 option.</li>
<li><a href="http://www.radscan.com/nas.html" target="_blank" rel="noopener">Network Audio System</a> is a network transparent client/server audio transport system and can be enabled in Qt applications by setting the <code>NAS</code> Qt4 option.</li>
</ul>
<pre><code>echo &quot;QT4_OPTIONS=    CUPS QGTKSTYLE NAS&quot; &gt;&gt; /etc/make.conf
</code></pre><h3 id="Staying-Up-To-Date"><a href="#Staying-Up-To-Date" class="headerlink" title="Staying Up To Date"></a>Staying Up To Date</h3><p>Before updating your Ports tree or pkg catalogue on an already-installed computer I suggest checking out <a href="http://svnweb.freebsd.org/ports/head/UPDATING?view=markup" target="_blank" rel="noopener">UPDATING</a>. This file – also found at <code>/usr/ports/UPDATING</code> if you have an extracted Ports tree – tracks breaking changes in packages and the steps necessary to to fix them. It will tell you when configuration file syntax has changed, how to fix dependencies when ports split or merge, when default versions of packages change, and more. You can update your already-extracted Ports tree to the newest revision with <code>portsnap fetch update</code>. There are two common tools for programmatically upgrading your ports, <a href="http://freshports.org/ports-mgmt/portupgrade" title="ports-mgmt/portupgrade" target="_blank" rel="noopener">ports-mgmt/portupgrade</a> and <a href="http://freshports.org/ports-mgmt/portmaster" title="ports-mgmt/portmaster" target="_blank" rel="noopener">ports-mgmt/portmaster</a>. I prefer portupgrade because portmaster stubbornly aborts the entire upgrade on any error, but you might like it. The common portmaster usage is <code>portmaster -a</code> to upgrade installed ports. I usually update with <code>portupgrade -rac</code>, with <code>-r`</code>-a<code>to recursively update all installed ports and</code>-c<code>to preemptively show new port options so they won’t interrupt the build. If you are using binary packages you can update the package repository catalog with</code>pkg update<code>and upgrade your installed packages with</code>pkg upgrade`. The Handbook has a more detailed chapter on <a href="http://www.freebsd.org/doc/handbook/ports-using.html" target="_blank" rel="noopener">using Ports</a> that includes upgrading and other tasks.</p>
<h2 id="Going-Graphical"><a href="#Going-Graphical" class="headerlink" title="Going Graphical"></a>Going Graphical</h2><p>I’m sure you’re eager to get out of the text-only console. To do so you need to install the <a href="http://www.x.org/wiki/" target="_blank" rel="noopener">X.org</a> distribution of the <a href="http://magcius.github.io/xplain/article/index.html" target="_blank" rel="noopener">X Window System</a> from <a href="http://freshports.org/x11/xorg" title="x11/xorg" target="_blank" rel="noopener">x11/xorg</a> with <code>pkg install xorg</code>. X.org by default uses FreeBSD’s <a href="http://www.freebsd.org/cgi/man.cgi?query=devd&amp;ektion=&amp;manpath=" title="man devd" target="_blank" rel="noopener">devd</a> for hardware detection and <a href="http://www.freedesktop.org/wiki/Software/dbus/" target="_blank" rel="noopener">D-Bus</a> for interprocess communication. <a href="http://www.freedesktop.org/wiki/Software/hal/" target="_blank" rel="noopener">HAL</a> used to be the default hardware detection mechanism but is in the process of deprecation, so you may not need it unless you plan to use a desktop environment that still depends on it. Check the dependencies for <a href="http://freshports.org/sysutils/hal" title="sysutils/hal" target="_blank" rel="noopener">sysutils/hal</a> for a list of software still requiring it. /etc/rc.conf</p>
<pre><code>hald_enable=&quot;YES&quot;
dbus_enable=&quot;YES&quot;
</code></pre><p>X.org on its own is just the display server. It needs stuff to display. You can install applications, but you also need a window manager to handle displaying and interacting with those applications in the way you’d expect from any modern OS. By default X comes with the <a href="https://en.wikipedia.org/wiki/Twm" target="_blank" rel="noopener">Tab Window Manager</a> which is probably not software you would enjoy using in the 21st century.</p>
<h3 id="Install-fonts"><a href="#Install-fonts" class="headerlink" title="Install fonts"></a>Install fonts</h3><p>X.org doesn’t include many attractive typefaces by default. Luckily, there are plenty <a href="http://freshports.org/x11-fonts/" title="available in Ports" target="_blank" rel="noopener">available in Ports</a>. Here are a few I use, including many from non-Roman languages for better Unicode coverage. On a new system I usually install something like:  </p>
<pre><code>pkg install chinese/arphicttf chinese/font-std hebrew/culmus hebrew/elmar-fonts japanese/font-ipa japanese/font-ipa-uigothic japanese/font-ipaex japanese/font-kochi japanese/font-migmix japanese/font-migu japanese/font-mona-ipa japanese/font-motoya-al japanese/font-mplus-ipa japanese/font-sazanami japanese/font-shinonome japanese/font-takao japanese/font-ume japanese/font-vlgothic x11-fonts/hanazono-fonts-ttf japanese/font-mikachan korean/aleefonts-ttf korean/nanumfonts-ttf korean/unfonts-core x11-fonts/anonymous-pro x11-fonts/artwiz-aleczapka x11-fonts/dejavu x11-fonts/inconsolata-ttf x11-fonts/terminus-font x11-fonts/cantarell-fonts x11-fonts/droid-fonts-ttf x11-fonts/doulos x11-fonts/ubuntu-font x11-fonts/isabella x11-fonts/ecofont x11-fonts/junicode x11-fonts/khmeros x11-fonts/padauk x11-fonts/stix-fonts x11-fonts/charis x11-fonts/urwfonts-ttf russian/koi8r-ps x11-fonts/geminifonts x11-fonts/cyr-rfx x11-fonts/paratype x11-fonts/gentium-plus
</code></pre><p>This includes:</p>
<ul>
<li><a href="http://freshports.org/chinese/arphicttf" title="Arphicttf" target="_blank" rel="noopener">Arphicttf</a> and <a href="http://freshports.org/chinese/font-std" title="font-std" target="_blank" rel="noopener">font-std</a> for Chinese coverage.</li>
<li><a href="http://freshports.org/hebrew/culmus" title="Culmus" target="_blank" rel="noopener">Culmus</a> and <a href="http://freshports.org/hebrew/elmar-fonts" title="El-Mar" target="_blank" rel="noopener">El-Mar</a> for Hebrew language coverage.</li>
<li><a href="http://freshports.org/japanese/font-ipa" title="IPA" target="_blank" rel="noopener">IPA</a>, <a href="http://freshports.org/japanese/font-ipa-uigothic" title="IPA UIGothic" target="_blank" rel="noopener">IPA UIGothic</a>, <a href="http://freshports.org/japanese/font-ipaex" title="IPAex" target="_blank" rel="noopener">IPAex</a>, <a href="http://freshports.org/japanese/font-kochi" title="Kochi" target="_blank" rel="noopener">Kochi</a>, <a href="http://freshports.org/japanese/font-migmix" title="MigMix" target="_blank" rel="noopener">MigMix</a>, <a href="http://freshports.org/japanese/font-migu" title="Migu" target="_blank" rel="noopener">Migu</a>, <a href="http://freshports.org/japanese/font-mona-ipa" title="Mona" target="_blank" rel="noopener">Mona</a>, <a href="http://freshports.org/japanese/font-motoya-al" title="MOTOYA" target="_blank" rel="noopener">MOTOYA</a>, <a href="http://freshports.org/japanese/font-mplus-ipa" title="M+" target="_blank" rel="noopener">M+</a>, <a href="http://freshports.org/japanese/font-sazanami" title="Sazanami" target="_blank" rel="noopener">Sazanami</a>, <a href="http://freshports.org/japanese/font-shinonome" title="Shinonome" target="_blank" rel="noopener">Shinonome</a>, <a href="http://freshports.org/japanese/font-takao" title="Takao" target="_blank" rel="noopener">Takao</a>, <a href="http://freshports.org/japanese/font-ume" title="UmeFont" target="_blank" rel="noopener">UmeFont</a>, <a href="http://freshports.org/japanese/font-vlgothic" title="VLGothic" target="_blank" rel="noopener">VLGothic</a>, <a href="http://freshports.org/x11-fonts/hanazono-fonts-ttf" title="Hanazono Mincho" target="_blank" rel="noopener">Hanazono Mincho</a>, and <a href="http://freshports.org/japanese/mikachan-ttfonts" title="Mika-chan" target="_blank" rel="noopener">Mika-chan</a> for Japanese language coverage.</li>
<li><a href="http://freshports.org/korean/aleefonts-ttf" title="A-Lee fonts" target="_blank" rel="noopener">A-Lee fonts</a>, <a href="http://freshports.org/korean/nanumfonts-ttf" title="Nanum" target="_blank" rel="noopener">Nanum</a>, and <a href="http://freshports.org/korean/unfonts-core" title="Un fonts" target="_blank" rel="noopener">Un fonts</a> for Korean language coverage.</li>
<li><a href="http://freshports.org/x11-fonts/anonymous-pro" title="Anonymous Pro" target="_blank" rel="noopener">Anonymous Pro</a>, <a href="http://freshports.org/x11-fonts/artwiz-aleczapka" title="artwiz-aleczapka" target="_blank" rel="noopener">artwiz-aleczapka</a>, <a href="http://freshports.org/x11-fonts/dejavu" title="DejaVu" target="_blank" rel="noopener">DejaVu</a>, <a href="http://freshports.org/x11-fonts/inconsolata-ttf" title="Inconsolata" target="_blank" rel="noopener">Inconsolata</a>, and <a href="http://freshports.org/x11-fonts/terminus-font" title="Terminus" target="_blank" rel="noopener">Terminus</a> for terminals and editors.</li>
<li><a href="http://freshports.org/x11-fonts/cantarell-fonts" title="Cantarell" target="_blank" rel="noopener">Cantarell</a>, <a href="http://freshports.org/x11-fonts/droid-fonts-ttf" title="Droid" target="_blank" rel="noopener">Droid</a>, <a href="http://freshports.org/x11-fonts/doulos" title="Doulos SIL" target="_blank" rel="noopener">Doulos SIL</a>, and <a href="http://freshports.org/x11-fonts/ubuntu-font" title="Ubuntu" target="_blank" rel="noopener">Ubuntu</a> for general Roman alphabet language coverage.</li>
<li><a href="http://freshports.org/x11-fonts/fonts-te" title="Telugu" target="_blank" rel="noopener">Telugu</a> for Telugu language.</li>
<li><a href="http://freshports.org/x11-fonts/isabella" title="Isabella" target="_blank" rel="noopener">Isabella</a>, <a href="http://freshports.org/x11-fonts/ecofont" title="Ecofont" target="_blank" rel="noopener">Ecofont</a>, and <a href="http://freshports.org/x11-fonts/junicode" title="Junicode" target="_blank" rel="noopener">Junicode</a> as novelty typefaces.</li>
<li><a href="http://freshports.org/x11-fonts/khmeros" title="KhmerOS" target="_blank" rel="noopener">KhmerOS</a> for Khmer language coverage.</li>
<li><a href="http://freshports.org/x11-fonts/padauk" title="Padauk" target="_blank" rel="noopener">Padauk</a> for Myanmar language coverage.</li>
<li><a href="http://freshports.org/x11-fonts/stix-fonts" title="STIX" target="_blank" rel="noopener">STIX</a> and <a href="http://freshports.org/print/cm-super" title="Computer Modern" target="_blank" rel="noopener">Computer Modern</a> for technical and mathematic symbols.</li>
<li><a href="http://freshports.org/x11-fonts/charis" title="Charis" target="_blank" rel="noopener">Charis</a>, <a href="http://freshports.org/x11-fonts/urwfonts-ttf" title="URW" target="_blank" rel="noopener">URW</a>, <a href="http://freshports.org/russian/koi8r-ps" title="KOI8" target="_blank" rel="noopener">KOI8</a>, <a href="http://freshports.org/x11-fonts/geminifonts" title="Geminifonts" target="_blank" rel="noopener">Geminifonts</a>, <a href="http://freshports.org/x11-fonts/cyr-rfx" title="CYR-RFX" target="_blank" rel="noopener">CYR-RFX</a>, and <a href="http://freshports.org/x11-fonts/paratype" title="ParaType" target="_blank" rel="noopener">ParaType</a> for Cyrillic and Eastern European language coverage.</li>
</ul>
<p><a href="http://freshports.org/x11-fonts/webfonts" title="x11-fonts/webfonts" target="_blank" rel="noopener">x11-fonts/webfonts</a> is a special case. It includes the <a href="https://www.microsoft.com/typography/fonts/web.aspx" target="_blank" rel="noopener">Microsoft Core Fonts for the Web</a> such as Andale and Verdana. If you own a valid Microsoft Windows license you can get Tahoma as well by adding to <code>/etc/make.conf</code> and building a custom package. /etc/make.conf</p>
<pre><code># Enable Tahoma in x11-fonts/webfonts if you have a Windows license
# You show me yours and I&apos;ll show you mine ;)
.if ${.CURDIR:M*/x11-fonts/webfonts}
WITH_MSWINDOWS_LICENSE=yes
.endif
</code></pre><p>Now that those fonts are installed you need to tell Xorg about them using a <code>FontPath</code> in your <code>/etc/X11/xorg.conf</code> so they can be used. Unfortunately the font paths in Ports are not entirely standardized. Most of them end up in <code>/usr/local/lib/X11/fonts</code>, some end up in <code>/usr/local/share/fonts/</code>, and some in just <code>/usr/local/share/</code>. Here’s the relevant section from my <code>xorg.conf</code>. Yours should look similar. In the past it was necessary to tell X about your installed fonts using <code>FontPath</code> directives in <code>xorg.conf</code>, but these days most software will detect them automatically using <a href="https://www.freedesktop.org/wiki/Software/fontconfig/" target="_blank" rel="noopener">fontconfig</a>. You probably won’t run into a case where you will need to, but you can manually inform the X server of fonts like this:  </p>
<pre><code>Section &quot;Files&quot;
    FontPath        &quot;/usr/local/lib/X11/fonts/Liberation/&quot;
    FontPath        &quot;/usr/local/lib/X11/fonts/anonymous-pro/&quot;
    FontPath        &quot;/usr/local/share/font-mona-ipa/&quot;
EndSection
</code></pre><p>You can install other invididual fonts later for a single user by copying them inside the <code>~/.fonts</code> directory under your <a href="https://en.wikipedia.org/wiki/Home_directory" target="_blank" rel="noopener">home directory</a>. You can re-scan the configured <code>FontPath</code>s and automatically-detected fonts by running <code>fc-cache -vf</code> and can list all installed fonts with <code>fc-list</code> to check that they all appear. For example, I have a fairly large local font repository in my <code>~/.fonts/</code> directory and have 2313 fonts available on my system as of this writing according to <code>fc-list | wc -l</code>.</p>
<h3 id="Starting-X"><a href="#Starting-X" class="headerlink" title="Starting X"></a>Starting X</h3><p>The shell script <code>.xinitrc</code> in your home directory is the script that is executed for the lifecycle of your X session. <code>.xinitrc</code> is used to run startup applications and then run your window manager. When you finally end your X session your window manager will exit, <code>.xinitrc</code> will return, and the X server will stop. Here’s a simple example <code>.xinitrc</code>: ~/.xinitrc</p>
<pre><code>xscreensaver -no-splash &amp;
xdg-user-dirs-update &amp;
redshift &amp;
compton &amp;
exec wmaker
</code></pre><p>In my example <code>.xinitrc</code> I use <a href="https://cooltrainer.org/a-freebsd-desktop-howto/#window-maker" target="_blank" rel="noopener">Window Maker</a> and start <a href="http://freshports.org/x11/xscreensaver" title="x11/xscreensaver" target="_blank" rel="noopener">x11/xscreensaver</a>, <a href="http://freedesktop.org/wiki/Software/xdg-user-dirs/" target="_blank" rel="noopener">xdg-user-dirs</a>, <a href="http://freshports.org/accessibility/redshift" title="accessibility/redshift" target="_blank" rel="noopener">accessibility/redshift</a>, and the lightweight compositor <a href="http://freshports.org/x11-wm/compton" title="x11-wm/compton" target="_blank" rel="noopener">x11-wm/compton</a>. Starting your graphical session after logging in on a TTY (the command-line login prompt) is the traditional way and is as easy as running the command <code>startx</code> after loggin in as your user. Don’t run X as root. I prefer to use a graphical login manager. Some desktop environments include their own, like KDE’s KDM. On my computer I use the environment-agnostic <a href="http://freshports.org/x11/slim" title="x11/slim" target="_blank" rel="noopener">x11/slim</a>. A graphical login manager, besides being nicer to look at, also protects you from leaving a logged-in user session (or even worse, a root session!) on a TTY that could be used by someone walking up to your computer. You can configure the login manager to start at boot by adding either <code>kdm_enable=&quot;YES&quot;</code> or <code>slim_enable=&quot;YES&quot;</code> to <code>/etc/rc.conf</code>, but I would recommend not doing that until you are confident everything is set up correctly. It will be more difficult to fix a config file if your computer automatically starts to a broken X server. Test a plain old <code>startx</code> first, then test your login manager with <code>service slim onestart</code> or <code>service kdm onestart</code> before enabling them for every boot. You can configure the <code>sessiondir</code> directive in the SLiM configuration file to define the path to <a href="http://standards.freedesktop.org/desktop-entry-spec/latest/" target="_blank" rel="noopener">desktop entries</a> installed by your ports, usually <code>/usr/local/share/xsessions</code>. Use <code>exec $1</code> instead of a particular window manager’s executable name in your <code>.xinitrc</code> to run the command from SLiM passed in as an argument. /usr/local/etc/slim.conf</p>
<pre><code>sessiondir /usr/local/share/xsessions/




echo &apos;slim_enable=&quot;YES&quot;&apos; &gt;&gt; /etc/rc.conf
service slim start
</code></pre><p>~/.xinitrc</p>
<pre><code>exec $1
</code></pre><p>  <img src="https://w.msla.top/wordpress/wp-content/uploads/2017/08/762cec3ace25c26b301473518baf1734.png" alt="">   You can switch session (window manager) with the _F1_ key on the SLiM login screen. The X session will use one of the virtual <a href="http://www.freebsd.org/cgi/man.cgi?query=ttys&amp;ektion=&amp;manpath=" title="man ttys" target="_blank" rel="noopener">ttys</a>. Once started, you can switch to a different virtual TTY with <em>CTRL-ATL-F#</em>. You can switch back to the graphical TTY with <em>CTRL-ATL-F9</em>. You may need to create a desktop entry for your window manager of choice if the port maintainer doesn’t ship one. Here’s an example, again for <a href="https://cooltrainer.org/a-freebsd-desktop-howto/#windowmaker" target="_blank" rel="noopener">Window Maker</a>. /usr/local/share/xsessions/wmaker.desktop </p>
<pre><code>[Desktop Entry]
Encoding=UTF-8
Name=Window Maker
Exec=/usr/local/bin/wmaker
Comment=This session logs you into Window Maker
Type=Application
</code></pre><h3 id="Automatic-configuration"><a href="#Automatic-configuration" class="headerlink" title="Automatic configuration"></a>Automatic configuration</h3><p>Versions of X.org since 1.2 (X11R7.2) in 2007 have supported autoconfiguration of display devices. HAL automatically detects input devices, and fontconfig automatically detects fonts, so you may never need <code>/etc/X11/xorg.conf</code> at all! Once you’ve set up your <code>.xinitrc</code> to use your window manager of choice, just give <code>startx</code> a try. Hopefully it will work flawlessly. If it does feel free to skip the sections on manual configuration. That should only be necessary if you need to force a specific video driver, toggle a specific option, or just <a href="http://web.mit.edu/~simsong/www/ugh.pdf#page=161" target="_blank" rel="noopener">hate yourself</a> and feel like learning one of the worst configuration file formats of all time.</p>
<h3 id="Manual-configuration"><a href="#Manual-configuration" class="headerlink" title="Manual configuration"></a>Manual configuration</h3><p>This section explains how you can manually configure X for systems using an AMD Radeon and the <a href="http://www.x.org/archive/X11R7.7/doc/man/man4/radeon.4.xhtml" target="_blank" rel="noopener"><code>radeon</code></a> driver, an Intel grahpics chip with the <a href="http://www.x.org/archive/X11R7.7/doc/man/man4/intel.4.xhtml" target="_blank" rel="noopener"><code>intel</code></a> driver, virtualized graphics cards like <a href="http://freshports.org/emulators/virtualbox-ose-additions" title="emulators/virtualbox-ose-additions" target="_blank" rel="noopener">emulators/virtualbox-ose-additions</a>’s <code>vboxvideo</code>, or any other generic framebuffer device supported by the default <a href="http://www.x.org/archive/X11R7.7/doc/man/man4/vesa.4.xhtml" target="_blank" rel="noopener"><code>vesa</code></a> driver. If autodetection works you shouldn’t have to do this. As root, run <code>X -configure</code>. It will spit out a new <a href="http://www.x.org/releases/X11R7.7/doc/man/man5/xorg.conf.5.xhtml" target="_blank" rel="noopener">X.org configuration file</a> in <code>/root/xorg.conf.new</code> based on your detected hardware. Copy this file to <code>/etc/X11/xorg.conf</code>, then pull it up in a text editor for a few modifications. Add an “Extensions” section and enable the <a href="http://www.x.org/releases/X11R7.7/doc/compositeproto/compositeproto.txt" target="_blank" rel="noopener">Composite</a> extension.  </p>
<pre><code>Section &quot;Extensions&quot;
    Option    &quot;Composite&quot; &quot;Enable&quot;
EndSection
</code></pre><p>Add one line to the <code>ServerLayout</code> section to enable <a href="http://fedoraproject.org/wiki/RenderingProject/aiglx" target="_blank" rel="noopener">AIGLX</a>.  </p>
<pre><code>Section &quot;ServerLayout&quot;
    Identifier     &quot;X.org Configured&quot;
    Screen      0  &quot;Screen0&quot; 0 0
    InputDevice    &quot;Mouse0&quot; &quot;CorePointer&quot;
    InputDevice    &quot;Keyboard0&quot; &quot;CoreKeyboard&quot;
    Option         &quot;AIGLX&quot; &quot;true&quot;
EndSection
</code></pre><p>I usually enable the <a href="http://www.cworth.org/tag/exa/" target="_blank" rel="noopener">EXA</a> <code>AccelMethod</code> and <code>DRI</code> by adding their respective lines to the <code>Device</code> section. If you have a Radeon card ensure your <code>Driver</code> is configured as <code>radeon</code>, not <code>radeonhd</code>! <a href="http://www.x.org/wiki/radeonhd" target="_blank" rel="noopener">radeonhd</a> is an older, Novell-sponsored, <a href="http://www.phoronix.com/scan.php?page=news_item&amp;px=ODIwOQ" target="_blank" rel="noopener">defunct</a> driver for Radeon HD hardware, but <code>-configure</code> likes to pick it by default if it’s installed. You should use <code>radeon</code> instead. Otherwise <code>X -configure</code> should pick the best driver.  </p>
<pre><code>Section &quot;Device&quot;
    Option     &quot;AccelMethod&quot; &quot;EXA&quot;
    Option     &quot;DRI&quot; &quot;true&quot;
    Identifier  &quot;Card0&quot;
    Driver      &quot;radeon&quot;
    VendorName  &quot;Advanced Micro Devices [AMD] nee ATI&quot;
    BoardName   &quot;RV770 [Radeon HD 4850]&quot;
    BusID       &quot;PCI:1:0:0&quot;
EndSection
</code></pre><p>Enable the <code>freetype</code>, <code>bitmap</code>, and <code>type1</code> X font modules by adding them to the <code>Module</code> section. According to the manual, “[t]he <code>extmod</code>, <code>dbe</code>, <code>dri</code>, <code>dri2</code>, <code>glx</code>, and <code>record</code> extension modules are loaded automatically if they are present”, but I like to go for the explicit configuration and define them anyway.  </p>
<pre><code>Section &quot;Module&quot;
    Load           &quot;dbe&quot;
    Load           &quot;dri&quot;
    Load           &quot;dri2&quot;
    Load           &quot;extmod&quot;
    Load           &quot;record&quot;
    Load           &quot;freetype&quot;
    Load           &quot;bitmap&quot;
    Load           &quot;type1&quot;
    Load           &quot;glx&quot;
EndSection
</code></pre><h3 id="Manual-Configuration-with-NVIDIA"><a href="#Manual-Configuration-with-NVIDIA" class="headerlink" title="Manual Configuration with NVIDIA"></a>Manual Configuration with NVIDIA</h3><p>Skip this section if you don’t use an NVIDIA graphics card or if automatic configuration works for you. The binary <a href="http://freshports.org/x11/nvidia-driver" title="x11/nvidia-driver" target="_blank" rel="noopener">x11/nvidia-driver</a> is the only proprietary software on my system. As much as I’d prefer a free and open solution, I’ve found that neither Nouveau nor the free Radeon or Intel driver compare to the speed and feature support of Nvidia’s official driver. Install the driver itself, <a href="http://freshports.org/x11/nvidia-settings" title="x11/nvidia-settings" target="_blank" rel="noopener">x11/nvidia-settings</a>, and <a href="http://freshports.org/x11/nvidia-xconfig" title="x11/nvidia-xconfig" target="_blank" rel="noopener">x11/nvidia-xconfig</a>. To load the nvidia kernel module at boot, enable it in <code>/boot/loader.conf</code>.  </p>
<pre><code>echo &apos;nvidia-modeset_load=&quot;YES&quot;&apos; &gt;&gt; /boot/loader.conf
</code></pre><p>Run <code>nvidia-xconfig</code> to get a base <a href="http://www.x.org/releases/X11R7.6/doc/man/man5/xorg.conf.5.xhtml" target="_blank" rel="noopener">xorg.conf</a> in <code>/etc/X11/xorg.conf</code>. Pull it up in your favourite text editor and add the <code>Module</code> section to enable the <code>freetype2</code>, <code>glx</code>, <code>type1</code> extensions. /etc/X11/xorg.conf</p>
<pre><code>Section &quot;Module&quot;
    Load           &quot;freetype&quot;
    Load           &quot;bitmap&quot;
    Load           &quot;type1&quot;
    Load           &quot;glx&quot;
EndSection
</code></pre><p>Later on, once you’re booted into the graphical environment, you can use <code>nvidia-settings</code> to configure TwinView and any other settings.</p>
<h2 id="Desktop-Environments"><a href="#Desktop-Environments" class="headerlink" title="Desktop Environments"></a>Desktop Environments</h2><p>The best part of the X Window System ecosystem is the variety of environments available. You might prefer the configurability of KDE, the sparse cleanliness of MATE, something minimal like Window Maker, or even tiling like i3. This isn’t <a href="http://xwinman.org/" target="_blank" rel="noopener">xwinman</a>, but I’ve included screenshots and descriptions for some of the most popular environments to give you an idea what’s out there.</p>
<h3 id="KDE-4"><a href="#KDE-4" class="headerlink" title="KDE 4"></a>KDE 4</h3><p><a href="http://kde.org/" target="_blank" rel="noopener">KDE</a> is the largest and most fully-featured Free Software desktop environment, based on the Qt toolkit. Its configuration options are dizzyingly numerous and it has excellent support for modern technologies like high-DPI displays. It has a modern compositing window manager, KWin, the web and file browser Konqueror that famously spawned the KHTML engine that became WebKit, and a family of other Qt applications like the excellent <a href="http://www.clementine-player.org/" target="_blank" rel="noopener">Clementine</a>. The KDE4 meta-port is available at <a href="http://freshports.org/x11/kde4" title="x11/kde4" target="_blank" rel="noopener">x11/kde4</a>.   <img src="https://w.msla.top/wordpress/wp-content/uploads/2017/08/e15a53d46c4d6acbc0cc1469a29f1a4e.png" alt="">   You can start KDE with <code>exec startkde</code> in your <code>.xinitrc</code>, but KDE also includes its own graphical <a href="https://cooltrainer.org/images/original/Alice-KDM.png" target="_blank" rel="noopener">login manager</a>, <a href="http://docs.kde.org/stable/en/kde-workspace/kdm/index.html" target="_blank" rel="noopener">KDM</a> which you can optionally enable in <code>rc.conf</code> and start as a service.  </p>
<pre><code>echo &apos;kdm4_enable=&quot;YES&quot;&apos; &gt;&gt; /etc/rc.conf
service kdm4 start
</code></pre><h3 id="MATE-nee-GNOME-2"><a href="#MATE-nee-GNOME-2" class="headerlink" title="MATE née GNOME 2"></a>MATE née GNOME 2</h3><p>GNOME 2 was a venerable desktop environment made famous as the Ubuntu default around 2008, and MATE is the community fork of GNOME 2 after the GNOME team lost their collective minds.   <img src="https://w.msla.top/wordpress/wp-content/uploads/2017/08/a7ba2a4060cc5fca0bda367f33e4fd05.png" alt="">   MATE users should configure <a href="http://www.freedesktop.org/wiki/Software/polkit" target="_blank" rel="noopener">PolicyKit</a> to allow normal users to mount removable media automatically. /usr/local/etc/PolicyKit/PolicyKit.conf </p>
<pre><code>&lt;config version=&quot;0.1&quot;&gt;
    &lt;match action=&quot;org.freedesktop.hal.storage.mount-removable&quot;&gt;
        &lt;return result=&quot;yes&quot;/&gt;
    &lt;/match&gt;
    &lt;match action=&quot;org.freedesktop.hal.storage.mount-fixed&quot;&gt;
        &lt;return result=&quot;yes&quot;/&gt;
    &lt;/match&gt;
    &lt;match user=&quot;root&quot;&gt;
        &lt;return result=&quot;yes&quot;/&gt;
    &lt;/match&gt;
    &lt;define_admin_auth group=&quot;wheel&quot;/&gt;
&lt;/config&gt;
</code></pre><p>MATE doesn’t include a GDM alternative, so start it with <code>exec mate-session</code> in your <code>.xinitrc</code> using either <code>startx</code> or SLiM. Compiz is a popular alternative window manager with MATE and GNOME 2 users. It gives you those fancy wobbly windows, 3d cubes, and all kinds of flashy stuff. You can install Compiz-Fusion from <a href="http://freshports.org/x11-wm/compiz-fusion" title="x11-wm/compiz-fusion" target="_blank" rel="noopener">x11-wm/compiz-fusion</a>. Be sure to disable the obsolete and unmaintained window decorator <a href="http://wiki.compiz.org/Decorators/Emerald" target="_blank" rel="noopener">Emerald</a>, a leftover from the Beryl project, when prompted on the port configuration screen. With Emerald disabled, compiz will default to <code>gtk-window-decorator</code> and will take on your normal GTK theme appearance but with more transparency and garish animation.   <img src="https://w.msla.top/wordpress/wp-content/uploads/2017/08/9a4edd933416689ef42531017c7220c2.png" alt="">   Once installed, open Settings &gt; Preferences &gt; CompizConfig Settings Manager. You’ll probably want to enable the following plugins at minimum:</p>
<ul>
<li>General: Gnome Compatibility</li>
<li>Desktop: Desktop Cube, Rotate Cube</li>
<li>Effects: Animations, Window Decoration, Wobbly Windows</li>
<li>Window Management: Application Switcher, Move Window, Place Windows, Resize Window</li>
</ul>
<p>Open the “Run” box with Alt+F2 and execute <code>compiz-manager</code>. <code>compiz-manager</code> is a script for detecting and using the proper compiz options for your video hardware. Your screen will flash while Compiz and gtk-window-decorator initialize and replace Marco, MATE’s default window manager. If your windows are missing titlebars, double-check you’ve enabled “Window Decoration” in <code>ccsm</code>. If all seems well, add <code>compiz-manager</code> as a new startup application (in Settings &gt; Preferences &gt; Startup Applications), then change MATE’s window manager preference in DConf:  </p>
<pre><code>gsettings set org.mate.session.required-components windowmanager compiz
</code></pre><p>To switch back, use the same command with the argument <code>marco</code>.</p>
<h3 id="Window-Maker"><a href="#Window-Maker" class="headerlink" title="Window Maker"></a>Window Maker</h3><p>It isn’t as popular or well-known as the others here, but <a href="http://windowmaker.org/" target="_blank" rel="noopener">Window Maker</a> is my favorite and longest-used window manager. It is based on the look and feel of the <a href="https://en.wikipedia.org/wiki/NEXTSTEP" target="_blank" rel="noopener">NEXTSTEP</a> operating system, the OS that became Rhapsody and then Mac OS X and iOS. Unlike the extremely limited one-dimensional Mac OS X dock, Window Maker offers a main dock as well as a “clip” dock that is unique to each virtual desktop. Docks can hold normal launchers and “dockapps”, small self-contained dock accessories.   <img src="https://w.msla.top/wordpress/wp-content/uploads/2017/08/9b7aa3e7b3fa31db8d1eb0cd3d91a318.png" alt="">   You can install Window Maker from <a href="http://freshports.org/x11-wm/windowmaker" title="x11-wm/windowmaker" target="_blank" rel="noopener">x11-wm/windowmaker</a> and start it with <code>exec wmaker</code> in your <code>.xinitrc</code>. In addition, I also show <a href="http://freshports.org/x11-clocks/wmclock" title="x11-clocks/wmclock" target="_blank" rel="noopener">x11-clocks/wmclock</a>, <a href="http://freshports.org/sysutils/wmcpuload" title="sysutils/wmcpuload" target="_blank" rel="noopener">sysutils/wmcpuload</a>, <a href="http://freshports.org/net/wmnd" title="net/wmnd" target="_blank" rel="noopener">net/wmnd</a>, <a href="http://freshports.org/audio/wmix" title="audio/wmix" target="_blank" rel="noopener">audio/wmix</a>, <a href="http://freshports.org/x11/sakura" title="x11/sakura" target="_blank" rel="noopener">x11/sakura</a>, and <a href="http://freshports.org/x11-fm/rox-filer" title="x11-fm/rox-filer" target="_blank" rel="noopener">x11-fm/rox-filer</a>. The first time you start Window Maker you should run <code>wmaker.inst</code> to install the starter configuration to your <code>~/GNUstep</code> directory.</p>
<h3 id="Enlightenment"><a href="#Enlightenment" class="headerlink" title="Enlightenment"></a>Enlightenment</h3><p><a href="http://www.enlightenment.org/" target="_blank" rel="noopener">Enlightenment</a> was the original eye-candy desktop before modern compositors were even a thing. <a href="http://www.enlightenment.org/?p=about/e17" target="_blank" rel="noopener">Version 0.17</a> was the ambitious rewrite release that almost never came out until <a href="http://e17releasemanager.wordpress.com/" target="_blank" rel="noopener">e17releasemanager</a> got it out the door. Since then it has followed a steady update schedule and is no longer vaporware. It contains an eye-catching desktop built on the project’s own <a href="https://en.wikipedia.org/wiki/Enlightenment_Foundation_Libraries" target="_blank" rel="noopener">Enlightenment Foundation Libraries</a>. E17 is shiny, bouncy, extendable, and very configurable. You can install it from <a href="http://freshports.org/x11-wm/enlightenment" title="x11-wm/enlightenment" target="_blank" rel="noopener">x11-wm/enlightenment</a> and run it with <code>exec enlightenment_start</code> in your <code>.xinitrc</code>.   <img src="https://w.msla.top/wordpress/wp-content/uploads/2017/08/a8fe3a3d8a9679085c3da6a021c74934.png" alt="">  </p>
<h3 id="XFCE"><a href="#XFCE" class="headerlink" title="XFCE"></a>XFCE</h3><p><a href="http://www.xfce.org/" target="_blank" rel="noopener">XFCE</a> descends, like <a href="https://en.wikipedia.org/wiki/K_Desktop_Environment_1" target="_blank" rel="noopener">KDE</a>, from the design of the once-proprietary <a href="https://en.wikipedia.org/wiki/Common_Desktop_Environment" target="_blank" rel="noopener">Common Desktop Environment</a>. As of XFCE 4.0, however, the desktop has become more of a GNOME-lite, the “other” GTK+ desktop environment. I don’t have much to say about it, but it is a very functional and lightweight desktop with panels, a window manager, a great file manager (Thunar), and some other lightweight applications like a terminal.   <img src="https://w.msla.top/wordpress/wp-content/uploads/2017/08/2d8750c29c1dcc71ab8d306d99a33595.png" alt="">   You can start XFCE with <code>exec startxfce4</code> in your <code>.xinitrc</code>.</p>
<h3 id="Cinnamon"><a href="#Cinnamon" class="headerlink" title="Cinnamon"></a>Cinnamon</h3><p><a href="http://cinnamon.linuxmint.com/" target="_blank" rel="noopener">Cinnamon</a> is a GTK 3 desktop environment from the Linux Mint project. It began as a fork of the GNOME 3 Shell into a more traditional panels and menus UI since many were dissatisfied with the drastic redesign of a beloved environment. It’s come into its own as a modern DE and offers everything you would expect from GNOME 2 or MATE with a cohesive feel and forks of several of the <a href="https://wiki.gnome.org/Design/Apps/" target="_blank" rel="noopener">GNOME core apps</a>. You can install Cinnamon from <a href="http://freshports.org/x11/cinnamon" title="x11/cinnamon" target="_blank" rel="noopener">x11/cinnamon</a> and start it with <code>exec cinnamon-session</code> in your <code>.xinitrc</code>. There is also a fallback software-rendering mode that can be started with <code>exec cinnamon-session-cinnamon2d</code> instead.   <img src="https://w.msla.top/wordpress/wp-content/uploads/2017/08/63d2407c50682a56b0ef949e4fd542df.png" alt="">  </p>
<h3 id="GNOME-3"><a href="#GNOME-3" class="headerlink" title="GNOME 3"></a>GNOME 3</h3><p><a href="http://www.gnome.org/gnome-3/" target="_blank" rel="noopener">GNOME 3</a>, available on Linux since 3.0 in the spring of 2011, is finally available in the official FreeBSD tree as of November 2014. The three and a half year delay is thanks to the upstream GNOME project’s <a href="https://blogs.oracle.com/jeffcai/entry/device_kit_will_replace_hal" target="_blank" rel="noopener">years-long</a> <a href="https://mail.gnome.org/archives/desktop-devel-list/2011-May/msg00439.html" target="_blank" rel="noopener">fight</a> against any operating system that doesn’t have a penguin for a mascot. It took several years and a vastly waning userbase, then suddenly <a href="http://blogs.gnome.org/desrt/2014/02/19/on-portability/" target="_blank" rel="noopener">they care about portability</a> again. Sure, okay. Either way, it’s here and you can install it from <a href="http://freshports.org/x11/gnome3" title="x11/gnome3" target="_blank" rel="noopener">x11/gnome3</a>. We <a href="https://cooltrainer.org/images/original/Gnome3-crashed-lol.png" target="_blank" rel="noopener">weren’t missing much</a> in the delay, since the GNOME team <a href="http://igurublog.wordpress.com/2012/11/05/gnome-et-al-rotting-in-threes/" target="_blank" rel="noopener">tossed out everything</a> great about their once-ubiquitous DE and turned it into a shiny but unconfigurable iOS imitator where basic features and options are either <a href="http://www.jwz.org/blog/2011/10/has-gnome-3-decided-that-people-shouldnt-want-screen-savers/" target="_blank" rel="noopener">not available at all</a>, buried inside a <a href="http://blog.fpmurphy.com/2011/03/customizing-the-gnome-3-shell.html" target="_blank" rel="noopener">settings registry</a> more reminiscent of Windows 98 than BSD, or relegated to extensions that will <a href="http://rrt.sc3d.org/Log/GNOME%203%20extensions:%20the%20madness%20must%20end" target="_blank" rel="noopener">break with every new minor version</a> thanks to the lack of any stable extensions API and whose very existence are <a href="https://mail.gnome.org/archives/gnome-shell-list/2011-June/msg00110.html" target="_blank" rel="noopener">opposed</a> by many of the main project contributors. Take a look at the <a href="https://extensions.gnome.org/" target="_blank" rel="noopener">GNOME Shell Extensions</a> page with me and be amused that you need an extension to <a href="https://extensions.gnome.org/extension/19/user-themes/" target="_blank" rel="noopener">use a theme</a>, <a href="https://extensions.gnome.org/extension/6/applications-menu/" target="_blank" rel="noopener">categorize the Applications menu</a>, remove the otherwise-omnipresent <a href="https://extensions.gnome.org/extension/112/remove-accesibility/" target="_blank" rel="noopener">accessibility menu</a> from the status bar, or even <a href="https://extensions.gnome.org/extension/5/alternative-status-menu/" target="_blank" rel="noopener">power off your computer</a> without knowing about the <a href="https://wiki.gnome.org/Projects/GnomeShell/CheatSheet#The_top_bar" target="_blank" rel="noopener">magic Alt-button toggle</a>.   <img src="https://w.msla.top/wordpress/wp-content/uploads/2017/08/a19467682d2a2b2a8b15b50b4abdcea3.png" alt="">   If you want a great GTK-based desktop environment maintained by a team that doesn’t hate you, check out <a href="https://cooltrainer.org/a-freebsd-desktop-howto/#mate-ne-gnome-2" target="_blank" rel="noopener">MATE</a>, <a href="https://cooltrainer.org/a-freebsd-desktop-howto/#xfce" target="_blank" rel="noopener">XFCE</a>, or <a href="https://cooltrainer.org/a-freebsd-desktop-howto/#cinnamon" target="_blank" rel="noopener">Cinnamon</a>. All three are excellent. I guess I can thank the GNOME project’s self-destruction for getting me back into <a href="https://cooltrainer.org/a-freebsd-desktop-howto/#window-maker" target="_blank" rel="noopener">Window Maker</a>.</p>
<h3 id="Theming"><a href="#Theming" class="headerlink" title="Theming"></a>Theming</h3><p><a href="https://cooltrainer.org/images/original/freebsd10-qgtkstyle.png" target="_blank" rel="noopener"><img src="https://w.msla.top/wordpress/wp-content/uploads/2017/08/b34ca84b3ad7d738566ec6e881947cf8.png" alt=""></a> Finding Clearlooks too drab and blue? You can find a world of themes and icons for MATE over on <a href="http://gnome-look.org/" target="_blank" rel="noopener">GNOME-Look</a>, for KDE at <a href="http://kde-look.org/" target="_blank" rel="noopener">KDE-Look</a>, for XFCE at <a href="http://xfce-look.org/" target="_blank" rel="noopener">XFCE-Look</a>, for E17 at <a href="http://e17-stuff.org/" target="_blank" rel="noopener">E17-Stuff</a>, and for several lightweight window managers at <a href="http://box-look.org/" target="_blank" rel="noopener">Box-Look</a>. There are several attractive and usable themes buried among the OS X Aqua clones, Vista Aero clones, and black-as-my-soul darkness-fests that are standard on any theming website. You can change theme settings for Qt4 applications with <code>qt4-qtconfig</code> and for KDE Qt applications (like Clementine) in the <a href="https://userbase.kde.org/System_Settings" target="_blank" rel="noopener">KDE System Settings</a>. GTK+ is selectable in many window managers’ appearance preferences, and you can also install <a href="http://freshports.org/x11-themes/lxappearance" title="x11-themes/lxappearance" target="_blank" rel="noopener">x11-themes/lxappearance</a> for a light GTK theme switcher.</p>
<h2 id="Extras-and-Miscellany"><a href="#Extras-and-Miscellany" class="headerlink" title="Extras and Miscellany"></a>Extras and Miscellany</h2><h3 id="Printing"><a href="#Printing" class="headerlink" title="Printing"></a>Printing</h3><p><a href="http://www.cups.org/" target="_blank" rel="noopener">CUPS</a> is the standard for printing on Free Unix-like systems and can be installed from Ports along with any needed filters. Install the CUPS meta-port at <a href="http://freshports.org/print/cups" title="print/cups" target="_blank" rel="noopener">print/cups</a>. Install <a href="http://hplipopensource.com/hplip-web/index.html" target="_blank" rel="noopener">HPLIP</a> in <a href="http://freshports.org/print/hplip" title="print/hplip" target="_blank" rel="noopener">print/hplip</a> for HP printer drivers (and my Brother HL-2170W, for some reason). Install the <a href="http://www.linuxfoundation.org/collaborate/workgroups/openprinting/database/foomatic" target="_blank" rel="noopener">Foomatic</a> filter collection in <a href="http://freshports.org/print/foomatic-filters" title="print/foomatic-filters" target="_blank" rel="noopener">print/foomatic-filters</a> and its database and engine in <a href="http://freshports.org/print/foomatic-db" title="print/foomatic-db" target="_blank" rel="noopener">print/foomatic-db</a> and <a href="http://freshports.org/print/foomatic-db-engine" title="print/foomatic-db-engine" target="_blank" rel="noopener">print/foomatic-db-engine</a>, respectively. I find the CUPS-PDF virtual printer in <a href="http://freshports.org/print/cups-pdf" title="print/cups-pdf" target="_blank" rel="noopener">print/cups-pdf</a> very useful as well. Enable CUPS once installed: /etc/rc.conf</p>
<pre><code># Disable line printer daemon since we have CUPS
lpd_enable=&quot;NO&quot;

# Enable CUPS
cupsd_enable=&quot;YES&quot;
</code></pre><p>Add local users to the <code>cups</code> group if you want them to be able to print.  </p>
<pre><code>pw usermod root -G cups
pw usermod okeeblow -G cups
</code></pre><p>Start the CUPS service with <code>service cupsd start</code> and you should be able to access its web configuration UI at <a href="http://localhost:631/" target="_blank" rel="noopener">http://localhost:631/</a> in your web browser. It may prompt you for your root password to write the config files in <code>/usr/local/etc/cups</code>. Most full desktop environments include a GUI to control CUPS and add printers, but the web interface is available in any of them.   <img src="https://w.msla.top/wordpress/wp-content/uploads/2017/08/935574bfa58b4e9dff214792c03e6298.png" alt="">   The web interfaces’ built-in documentation can help you configure different models of printer, specifically the <a href="http://localhost:631/help/network.html?TOPIC=Getting+Started&amp;QUERY=#PROTOCOLS" target="_blank" rel="noopener">Network Protocols Supported by CUPS</a> and <a href="http://localhost:631/help/network.html?TOPIC=Getting+Started&amp;QUERY=#URI" target="_blank" rel="noopener">Common Network Printer URIs</a> sections.</p>
<h3 id="S-M-R-T"><a href="#S-M-R-T" class="headerlink" title="S.M.R.T."></a>S.M.R.T.</h3><p><a href="http://freshports.org/sysutils/smartmontools" title="sysutils/smartmontools" target="_blank" rel="noopener">sysutils/smartmontools</a> installs <code>smartd</code> and <code>smartctl</code>, a daemon and utility for checking the <a href="https://en.wikipedia.org/wiki/S.M.A.R.T." target="_blank" rel="noopener">S.M.A.R.T.</a> status of your local disks. Enable the sample <code>smartd.conf</code>. It contains one directive, <code>DEVICESCAN</code>, that causes smartd to scan all attached drives.  </p>
<pre><code>cp /usr/local/etc/smartd.conf.sample /usr/local/etc/smartd.conf
echo &apos;smartd_enable=&quot;YES&quot;&apos; &gt;&gt; /etc/rc.conf
service smartd start
</code></pre><p>You can check the S.M.A.R.T. status of a drive directly with <code>smartctl</code> as root. The <code>-H</code> flag will show basic pass or fail health status, and the <code>-a</code> flag will show everything. smartctl -H /dev/ada0</p>
<pre><code>smartctl 6.2 2014-02-18 r3874 [FreeBSD 10.0-RELEASE-p2 amd64] (local build)
Copyright (C) 2002-13, Bruce Allen, Christian Franke, www.smartmontools.org

=== START OF READ SMART DATA SECTION ===
SMART overall-health self-assessment test result: PASSED
</code></pre><h3 id="Java"><a href="#Java" class="headerlink" title="Java"></a>Java</h3><p>FreeBSD has several available Java providers, including <a href="http://openjdk.java.net/" target="_blank" rel="noopener">OpenJDK</a> and Sun’s Oracle’s JDK. I recommend the newest OpenJDK for most people. It’s far easier to install than the binary Oracle JRE which requires logging in to a web page, agreeing to the license, and manually downloading the distfile for Ports. At the time of this writing the newest OpenJDK is <a href="http://freshports.org/java/openjdk8" title="java/openjdk8" target="_blank" rel="noopener">java/openjdk8</a>. OpenJDK 6 and 7 are available as well if you have software that doesn’t run on Java 8. If you need a Java browser plugin you can install <a href="http://freshports.org/java/icedtea-web" title="java/icedtea-web" target="_blank" rel="noopener">java/icedtea-web</a> once a Java provider is available.</p>
<h3 id="Webcams-and-DVB"><a href="#Webcams-and-DVB" class="headerlink" title="Webcams and DVB"></a>Webcams and DVB</h3><p>Most USB webcams and many DVB tuners are supported by <a href="http://freshports.org/multimedia/webcamd" title="multimedia/webcamd" target="_blank" rel="noopener">multimedia/webcamd</a>, and webcamd depends on the userland character device driver in <a href="http://freshports.org/multimedia/cuse4bsd-kmod" title="multimedia/cuse4bsd-kmod" target="_blank" rel="noopener">multimedia/cuse4bsd-kmod</a>. Install them, then enable them in <code>rc.conf</code> and <code>loader.conf</code>. /etc/rc.conf</p>
<pre><code># Webcam daemon
webcamd_enable=&quot;YES&quot;
</code></pre><p>/boot/loader.conf</p>
<pre><code># Userland character device driver for webcams
cuse4bsd_load=&quot;YES&quot;
</code></pre><p>You can use your camera device with <a href="http://raaf.atspace.org/" target="_blank" rel="noopener">pwcview</a> available in <a href="http://freshports.org/multimedia/pwcview" title="multimedia/pwcview" target="_blank" rel="noopener">multimedia/pwcview</a> or with <a href="https://wiki.gnome.org/Apps/Cheese" target="_blank" rel="noopener">Cheese</a> in <a href="http://freshports.org/multimedia/cheese" title="multimedia/cheese" target="_blank" rel="noopener">multimedia/cheese</a>. Cheese provides a nice interface similar to Apple’s Photobooth on OS X, but it has a heavy GNOME library dependency some may not want on their systems.</p>
<h3 id="IBus"><a href="#IBus" class="headerlink" title="IBus"></a>IBus</h3><p><a href="https://code.google.com/p/ibus/" target="_blank" rel="noopener">IBus</a> is a modern IME for Unix-like systems, allowing one to input <a href="https://en.wikipedia.org/wiki/CJK_characters" target="_blank" rel="noopener">CJK</a> languages. Install the main IME from <a href="http://freshports.org/textproc/ibus" title="textproc/ibus" target="_blank" rel="noopener">textproc/ibus</a> as well as QT application support from <a href="http://freshports.org/textproc/ibus-qt" title="textproc/ibus-qt" target="_blank" rel="noopener">textproc/ibus-qt</a>. You’ll need one or more input methods once the IME itself is installed. Ports of interest:</p>
<ul>
<li><a href="http://freshports.org/chinese/ibus-chewing" title="chinese/ibus-chewing" target="_blank" rel="noopener">chinese/ibus-chewing</a> - Chewing engine for IBus</li>
<li><a href="http://freshports.org/chinese/ibus-pinyin" title="chinese/ibus-pinyin" target="_blank" rel="noopener">chinese/ibus-pinyin</a> - The PinYin input method</li>
<li><a href="http://freshports.org/japanese/ibus-anthy" title="japanese/ibus-anthy" target="_blank" rel="noopener">japanese/ibus-anthy</a> - Anthy engine for IBus</li>
<li><a href="http://freshports.org/japanese/ibus-mozc" title="japanese/ibus-mozc" target="_blank" rel="noopener">japanese/ibus-mozc</a> - Mozc engine for IBus</li>
<li><a href="http://freshports.org/japanese/ibus-skk" title="japanese/ibus-skk" target="_blank" rel="noopener">japanese/ibus-skk</a> - SKK engine for IBus</li>
<li><a href="http://freshports.org/korean/ibus-hangul" title="korean/ibus-hangul" target="_blank" rel="noopener">korean/ibus-hangul</a> - Hangul engine for IBus</li>
<li><a href="http://freshports.org/textproc/ibus-kmfl" title="textproc/ibus-kmfl" target="_blank" rel="noopener">textproc/ibus-kmfl</a> - KMFL IMEngine for IBus framework</li>
<li><a href="http://freshports.org/textproc/ibus-m17n" title="textproc/ibus-m17n" target="_blank" rel="noopener">textproc/ibus-m17n</a> - The m17n IMEngine for IBus framework</li>
<li><a href="http://freshports.org/textproc/ibus-table" title="textproc/ibus-table" target="_blank" rel="noopener">textproc/ibus-table</a> - Table based IM framework for IBus</li>
</ul>
<p>Heavyweight desktop environments like GNOME or KDE will let you configure the input method graphically. In GNOME 2 and MATE, for example, you can open the IBus preferences from the Settings &gt; Preferences menu. KDE/Qt users can enable it as the default IME in <code>qtconfig-qt4</code>. Lightweight window manager users like me can start it in <code>.xinitrc</code>: ~/.xinitrc</p>
<pre><code>export XMODIFIERS=&quot;@im=ibus&quot;
export GTK_IM_MODULE=&quot;ibus&quot;
export QT_IM_MODULE=&quot;ibus&quot;
exec ibus-daemon -d -x &amp;
</code></pre><p>Now run any GTK or QT application, press your keyboard shortcut to switch input methods, and test it out. <a href="https://cooltrainer.org/images/original/IBusmethods.png" target="_blank" rel="noopener"><img src="https://w.msla.top/wordpress/wp-content/uploads/2017/08/d75f0d935d5fd2ec48c161fcd96de4f1.png" alt=""></a> <a href="https://cooltrainer.org/images/original/GVim-nihongo.png" target="_blank" rel="noopener"><img src="https://w.msla.top/wordpress/wp-content/uploads/2017/08/2a24b25dd4df49fee6443685ae46f1f2.png" alt=""></a></p>
<h3 id="Linuxulator"><a href="#Linuxulator" class="headerlink" title="Linuxulator"></a>Linuxulator</h3><p>FreeBSD’s <a href="http://www.freebsd.org/cgi/man.cgi?query=linux&amp;ektion=&amp;manpath=FreeBSD%2011.0-RELEASE" title="man linux from FreeBSD 11.0-RELEASE" target="_blank" rel="noopener">Linuxulator</a> allows it to run Linux application binaries using <a href="http://www.leidinger.net/blog/2010/09/28/the-freebsd-linuxulator-explained-for-users/" target="_blank" rel="noopener">system call translation</a>. Desktop users will find it useful for running the handful of proprietary but necessary programs that are available for Linux but not for FreeBSD, such as <a href="http://www.adobe.com/support/security/#flashplayer" target="_blank" rel="noopener">Adobe Flash Player</a>. Install the Linux base distribution from Ports. As I write this the default base distribution is <a href="http://freshports.org/emulators/linux_base-c6" title="emulators/linux_base-c6" target="_blank" rel="noopener">emulators/linux_base-c6</a>, based on CentOS 6, replacing the old Fedora 10 based <code>linux_base-f10</code>. A newer CentOS 7 <a href="http://freshports.org/emulators/linux_base-c7" title="emulators/linux_base-c7" target="_blank" rel="noopener">emulators/linux_base-c7</a> is also available and will become the default at some point in the future. Once your chosen <code>linux_base</code> installed, tell your system to load the <code>linux</code> kernel module at boot.  </p>
<pre><code>echo &apos;linux_load=&quot;YES&quot;&apos; &gt;&gt; /boot/loader.conf
kldload linux
</code></pre><p>Mount the <a href="http://www.freebsd.org/cgi/man.cgi?query=linprocfs&amp;ektion=&amp;manpath=" title="man linprocfs" target="_blank" rel="noopener">linprocfs</a> virtual filesystems for compatibility with GNOME and other programs requiring them. /etc/fstab</p>
<pre><code>linproc   /compat/linux/proc   linprocfs,auto,late   rw   0  0
</code></pre><p>  <img src="https://w.msla.top/wordpress/wp-content/uploads/2017/08/a993a24ae9704b9f89f4904186513e2a.png" alt="">   Besides proprietary garbageware like Flash Player I also use Linuxulator along with the <a href="http://www.swanson.ukfsn.org/loki/" target="_blank" rel="noopener">Loki compatibility library package</a> to run <a href="https://en.wikipedia.org/wiki/Loki_Software" target="_blank" rel="noopener">Loki Software</a>’s Linux ports of some of the best PC games ever made, like Simcity 3000 Unlimited.</p>
<h3 id="Wine"><a href="#Wine" class="headerlink" title="Wine"></a>Wine</h3><p>Wine is a free implementation of the Win32 API capable of running real Windows applications on Unix-like systems. It’s available from <a href="http://freshports.org/emulators/wine" title="emulators/wine" target="_blank" rel="noopener">emulators/wine</a> <a href="http://freshports.org/emulators/wine-devel" title="emulators/wine-devel" target="_blank" rel="noopener">emulators/wine-devel</a>, or <a href="http://freshports.org/emulators/wine-staging" title="emulators/wine-staging" target="_blank" rel="noopener">emulators/wine-staging</a>, containing the latest stable, unstable, and staging versions respectively. The optional <a href="http://freshports.org/emulators/wine-gecko" title="emulators/wine-gecko" target="_blank" rel="noopener">emulators/wine-gecko</a> is an <code>mshtml.dll</code> replacement that will allow Windows programs to embed web pages using the Mozilla engine. The optional <a href="http://freshports.org/emulators/wine-mono" title="emulators/wine-mono" target="_blank" rel="noopener">emulators/wine-mono</a> will let Wine run Windows programs written in versions 1.x or 2.0 of the <a href="http://en.wikipedia.org/wiki/.NET_Framework" target="_blank" rel="noopener">.NET Framework</a> without using the proprietary .NET runtime. You can also install <a href="http://freshports.org/emulators/winetricks" title="emulators/winetricks" target="_blank" rel="noopener">emulators/winetricks</a>, a script containing Wine installation recipes for popular software, and you may find a Wine GUI such as <a href="http://freshports.org/emulators/swine" title="emulators/swine" target="_blank" rel="noopener">emulators/swine</a> useful for maintaining separate Wine prefixes. Installing 64-bit Wine on an <code>amd64</code> FreeBSD system normally precludes you from running 32-bit Windows software, a.k.a. most of the software you probably care about. As a workaround, <code>i386</code> Wine packages are also available. You can install them from <a href="http://freshports.org/emulators/i386-wine" title="emulators/i386-wine" target="_blank" rel="noopener">emulators/i386-wine</a>, <a href="http://freshports.org/emulators/i386-wine-devel" title="emulators/i386-wine-devel" target="_blank" rel="noopener">emulators/i386-wine-devel</a>, or <a href="http://freshports.org/emulators/i386-wine-staging" title="emulators/i386-wine-staging" target="_blank" rel="noopener">emulators/i386-wine-staging</a>. If you plan to use Wine to run <a href="https://cooltrainer.org/a-freebsd-desktop-howto/#browser-plugins" target="_blank" rel="noopener">browser plugins</a>, use the <code>staging</code>-patched version of wine in <a href="http://freshports.org/emulators/wine-staging" title="emulators/wine-staging" target="_blank" rel="noopener">emulators/wine-staging</a> or <a href="http://freshports.org/emulators/i386-wine-staging" title="emulators/i386-wine-staging" target="_blank" rel="noopener">emulators/i386-wine-staging</a>.   <img src="https://w.msla.top/wordpress/wp-content/uploads/2017/08/50c0e7b7b530042285f8e3806e05b2a3.png" alt="">   Wine is very impressively-compatible these days. I use it to run a lot of games from <a href="https://www.humblebundle.com/store" target="_blank" rel="noopener">Humble Store</a> and <a href="http://www.gog.com/" target="_blank" rel="noopener">GOG</a> so I don’t have to fire up a Windows computer or VM. Wine is so good it is used to create the Linux versions of many of these titles, such as <a href="http://freedomplanet.galaxytrail.com/" target="_blank" rel="noopener">Freedom Planet</a>, and in that case it’s a lot easier to run the same executable in FreeBSD Wine than to try and get the Linux Wine binaries running via <a href="https://cooltrainer.org/a-freebsd-desktop-howto/#linuxulator" target="_blank" rel="noopener">Linuxulator</a>. If every <code>wine</code> command fails with <code>ELF interpreter /libexec/ld-elf.so.1 not found</code> your 64-bit system is missing the 32-bit libraries necessary for Wine. You’ll need to install them. From the <a href="https://cooltrainer.org/a-freebsd-desktop-howto/ftp://ftp.freebsd.org/pub/FreeBSD/releases/amd64/" target="_blank" rel="noopener">releases FTP</a>, grab the <code>lib32.txz</code> matching your version of the OS and extract it either as root or with sudo to the root of your filesystem to install. The archive contains a full directory hierarchy so all the files will end up in the right place.  </p>
<pre><code>fetch ftp://ftp.freebsd.org/pub/FreeBSD/releases/amd64/11.0-RELEASE/lib32.txz
tar xfp lib32.txz -C /
</code></pre><h3 id="Browser-Plugins"><a href="#Browser-Plugins" class="headerlink" title="Browser Plugins"></a>Browser Plugins</h3><blockquote>
<p>NOTE on <a href="https://en.wikipedia.org/wiki/NPAPI" target="_blank" rel="noopener">NPAPI</a> Deprecation: <a href="https://blog.mozilla.org/futurereleases/2015/10/08/npapi-plugins-in-firefox/" target="_blank" rel="noopener">Firefox</a> and <a href="https://blog.chromium.org/2014/11/the-final-countdown-for-npapi.html" target="_blank" rel="noopener">Chromium</a> are deprecating support for NPAPI plugins, so everything in this section will stop working at that time. Chromium removed support as of version 32. Firefox 52 is the last version with support and will be available as <a href="http://freshports.org/www/firefox-esr" title="www/firefox-esr" target="_blank" rel="noopener">www/firefox-esr</a> until the release of ESR 60.</p>
</blockquote>
<p><a href="http://www.adobe.com/support/security/#flashplayer" target="_blank" rel="noopener">Adobe Flash Player</a> is not released for FreeBSD but is usable on FreeBSD i386 and amd64 through your choice of two wrappers. The 32-bit Linux version of the Flash plugin can be installed via <a href="http://freshports.org/www/linux-c6-flashplugin24" title="www/linux-c6-flashplugin24" target="_blank" rel="noopener">www/linux-c6-flashplugin24</a> or <a href="http://freshports.org/www/linux-c7-flashplugin24" title="www/linux-c7-flashplugin24" target="_blank" rel="noopener">www/linux-c7-flashplugin24</a>, executed through <a href="https://cooltrainer.org/a-freebsd-desktop-howto/#linuxulator" target="_blank" rel="noopener">Linuxulator</a>, and adapted to 32-bit or 64-bit native browsers with <a href="http://freshports.org/www/nspluginwrapper" title="www/nspluginwrapper" target="_blank" rel="noopener">www/nspluginwrapper</a>. Adobe <a href="http://www.zdnet.com/blog/open-source/adobe-abandons-linux/10418" target="_blank" rel="noopener">dropped support</a> for the NPAPI Linux version of Flash with version 11.2 back in 2012. They left development up to Google who deprecated NPAPI and only released a <a href="https://en.wikipedia.org/wiki/Google_Native_Client#Pepper" target="_blank" rel="noopener">PPAPI</a> version for many years as part of their proprietary Chrome browser bundle, something that isn’t even available for FreeBSD. Adobe, in a surprising move, <a href="https://blogs.adobe.com/flashplayer/2016/08/beta-news-flash-player-npapi-for-linux.html" target="_blank" rel="noopener">resumed Linux NPAPI Flash plugin development</a> in 2016. To use nspluginwrapper, make sure <code>linprocfs</code> is mounted and execute <code>nspluginwrapper -v -a -i</code> as your normal user to locate and enable the Linux Flash plugin. <code>-a</code> automatically finds available plugins and <code>-i</code> installs them. It’s important to remember it makes a copy of the Flash library in your home directory when you do this, so every time you update the version of Flash installed through Ports you need to remove your local cory with <code>nspluginwrapper -v -a -r</code> and install the new one with <code>nspluginwrapper -v -a -i</code>. Adobe promised security updates for the NPAPI Flash Player through 2017, and if history is any indication <a href="http://www.cvedetails.com/product/6761/Adobe-Flash-Player.html?vendor_id=53" target="_blank" rel="noopener">you’re going to need them</a>. A newer and arguably better solution is <a href="http://freshports.org/emulators/pipelight" title="emulators/pipelight" target="_blank" rel="noopener">emulators/pipelight</a>, a <a href="https://cooltrainer.org/a-freebsd-desktop-howto/#wine" target="_blank" rel="noopener">Wine</a>-based wrapper for Windows browsers plugins. It supports the very newest version of Windows Flash, freeing us from the limitations of Adobe’s Linux development, and also supports Shockwave, Silverlight, Unity, Widevine, and more. It requires a special patched version of Wine, <a href="http://freshports.org/emulators/wine-staging" title="emulators/wine-staging" target="_blank" rel="noopener">emulators/wine-staging</a> or <a href="http://freshports.org/emulators/i386-wine-staging" title="emulators/i386-wine-staging" target="_blank" rel="noopener">emulators/i386-wine-staging</a>. Once installed, activate plugins as root.  </p>
<pre><code>pipelight-plugin --update
pipelight-plugin --create-mozilla-plugins
pipelight-plugin --enable flash
</code></pre><p>Silverlight is available as well and can allow you to watch DRMed NetFlix content via your browser on FreeBSD. I have no experience using it since I don’t buy DRMed streaming media subscriptions, but it can be installed the same way.  </p>
<pre><code>pipelight-plugin --enable silverlight5.1
</code></pre><p>Heed <a href="http://freshports.org/www/pipelight" title="www/pipelight" target="_blank" rel="noopener">www/pipelight</a>’s <a href="https://svnweb.freebsd.org/ports/head/emulators/pipelight/pkg-message?view=log" target="_blank" rel="noopener">pkg-message</a> warning about Silverlight DRM if you have a ZFS-based system:</p>
<blockquote>
<p>For users running with ZFS on root, watching DRM protected content requires extensive xattr support. If you run into issues with DRM failing, you can use the “pipelight-mkufs” command to create a UFS formatted ZVOL mounted on your users ~/.wine-pipelight directory.</p>
</blockquote>
<p>Other plugins are enabled the same way, and the list of available plugins can be seen in <code>pipelight-plugin --help</code>.</p>
<h3 id="Virtualization"><a href="#Virtualization" class="headerlink" title="Virtualization"></a>Virtualization</h3><p>It’s pretty common to virtualize another operating system on your computer, possibly to run a proprietary program or access a proprietary office groupware system. Whatever the reason, it’s easy to accomplish on FreeBSD. <a href="https://cooltrainer.org/images/original/freebsd10-vboxmanage.png" target="_blank" rel="noopener"><img src="https://w.msla.top/wordpress/wp-content/uploads/2017/08/091b2509ea6e042ea139c40c61fd7d06.png" alt=""></a> FreeBSD 10 has a new built-in hypervisor known as <a href="http://bhyve.org/" target="_blank" rel="noopener">bhyve</a> capable of running FreeBSD natively and other operating systems via <a href="http://freshports.org/sysutils/grub2-bhyve" title="sysutils/grub2-bhyve" target="_blank" rel="noopener">sysutils/grub2-bhyve</a>. Originally bhyve supported only a serial console but as of FreeBSD 11 <a href="http://justinholcomb.me/blog/2016/05/28/bhyve-uefi-gop-support.html" target="_blank" rel="noopener">also supports graphics</a>. Alternatively, VirtualBox open source edition is available at <a href="http://freshports.org/emulators/virtualbox-ose" title="emulators/virtualbox-ose" target="_blank" rel="noopener">emulators/virtualbox-ose</a>. Build it with Guest Additions enabled for the best experience virtualizing Windows and Linux. To use VirtualBox, configure <code>loader.conf</code> to load the VirtualBox kernel module and configure <code>rc.conf</code> to start VirtualBox bridged networking. /boot/loader.conf </p>
<pre><code>vboxdrv_load=&quot;YES&quot;
</code></pre><p>/etc/rc.conf</p>
<pre><code>vboxnet_enable=&quot;YES&quot;
</code></pre><p>/etc/devfs.conf</p>
<pre><code># Allow VirtualBox network access
own     vboxnetctl      root:vboxusers
perm    vboxnetctl      0660




pw usermod okeeblow -G vboxusers
</code></pre><h3 id="Skype"><a href="#Skype" class="headerlink" title="Skype"></a>Skype</h3><p>Skype is bad, proprietary software that doesn’t value your freedom. Use <a href="http://freshports.org/audio/mumble" title="audio/mumble" target="_blank" rel="noopener">audio/mumble</a> or <a href="http://freshports.org/net-im/ekiga" title="net-im/ekiga" target="_blank" rel="noopener">net-im/ekiga</a> instead if you can. If you still wish to use Skype, make sure you have <a href="https://cooltrainer.org/a-freebsd-desktop-howto/#linuxulator" target="_blank" rel="noopener">Linuxulator</a> enabled and install <a href="http://freshports.org/net-im/skype" title="net-im/skype" target="_blank" rel="noopener">net-im/skype</a>. Version 2.1 of Skype’s Linux client dropped support for OSS, found in FreeBSD as the default sound API. Thanks to this, Skype 2.0 persisted for years as the version in Ports. With the introduction of an <a href="http://lists.freebsd.org/pipermail/svn-src-all/2011-May/038480.html" target="_blank" rel="noopener">ALSA compatibility shim in FreeBSD 8.3 and 9.0</a> and <a href="http://freshports.org/audio/linux-c6-alsa-plugins-oss" title="audio/linux-c6-alsa-plugins-oss" target="_blank" rel="noopener">audio/linux-c6-alsa-plugins-oss</a>, we can use the newer ALSA-only Skype 2.1 client. The ALSA client, unlike the old OSS client, requires some explicit configuration to use our sound devices. They must be defined manually in <code>/compat/linux/etc/alsa/pcm/pcm-oss.conf</code>, the configuration file of alsa-plugins-oss. In this example, I enable <code>pcm6</code>/<code>dsp6</code> for audio output, and <code>pcm8</code>/<code>dsp8</code>, a USB webcam, as a microphone source. /compat/linux/etc/alsa/pcm/pcm-oss.conf</p>
<pre><code>pcm.oss8 {
    type oss
    device /dev/dsp8
    hint {
        description &quot;Open Sound System - Webcam&quot;
    }
}

ctl.oss8 {
    type oss
    device /dev/mixer8
    hint {
        description &quot;Open Sound System - Webcam&quot;
    }
}

pcm.oss6 {
    type oss
    device /dev/dsp6
    hint {
        description &quot;Open Sound System - S/PDIF&quot;
    }
}

ctl.oss6 {
    type oss
    device /dev/mixer6
    hint {
        description &quot;Open Sound System - S/PDIF&quot;
    }
}
</code></pre><p>There is an even newer Skype client available as <a href="http://freshports.org/net-im/skype4" title="net-im/skype4" target="_blank" rel="noopener">net-im/skype4</a>, but that version is not usable on FreeBSD 10.x due to <a href="https://reviews.freebsd.org/D907" target="_blank" rel="noopener">missing syscalls</a> in that branch’s Linuxulator. It will work via Pulseaudio in FreeBSD 11 and later. For Skype 4.x, load the Video4Linux2 wrapper module:  </p>
<pre><code>kldload linux_v4l2wrapper
echo &apos;linux_v4l2wrapper_load=&quot;YES&quot;&apos; &gt;&gt; /boot/loader.conf
</code></pre><p>The microphone volume can be controlled by invoking the mixer of your chosen recording device. Let’s raise the microphone volume now from 0% to 75%.  </p>
<pre><code>mixer -f /dev/mixer8 mic 75
</code></pre><h3 id="ISO-8601-and-other-locales"><a href="#ISO-8601-and-other-locales" class="headerlink" title="ISO-8601 and other locales"></a>ISO-8601 and other locales</h3><p>This is personal preference, but I also set my <code>LC_TIME</code> environment variable to the <code>en_DK</code> faux-locale for <a href="http://www.iso.org/iso/support/faqs/faqs_widely_used_standards/widely_used_standards_other/date_and_time_format.htm" target="_blank" rel="noopener">ISO-8601</a> date formats instead of the ridiculous American standard. Quick, what date is 6/5/12? Oh, it’s 2012-06-05, of course. The locale isn’t included with the FreeBSD base system as it is in many Linux distributions, but it’s <a href="http://ivoras.net/blog/tree/2010-12-20.the-wonderful-en_dk-locale.html" target="_blank" rel="noopener">available</a> from Ivan Voras’ blog.  </p>
<pre><code>tar -C /usr/share/locale -zxf /path/to/your/en_DK.UTF-8.tgz
</code></pre><p>Enable it in the login database and <code>/etc/profile</code>. /etc/login.conf</p>
<pre><code>@@ -46,7 +46,8 @@
     :ignoretime@:
     :umask=022:
     :charset=UTF-8:
-    :lang=en_US.UTF-8:
+    :lang=en_US.UTF-8:
+    :setenv=LC_TIME=en_DK.UTF-8:




cap_mkdb /etc/login.conf
</code></pre><p>/etc/profile</p>
<pre><code>LC_TIME=en_DK.UTF-8; export LC_TIME
</code></pre><h2 id="Upgrade-Notes"><a href="#Upgrade-Notes" class="headerlink" title="Upgrade Notes"></a>Upgrade Notes</h2><p>This guide assumes you will track the newest <code>STABLE</code> branch, upgrading to new stable branches at the initial <code>.0</code> release. That’s not a thing I would ever recommend with OS X, but I haven’t been burned by a new major FreeBSD version yet. This section notes things you need to know to keep your system in top shape when upgrading.</p>
<h3 id="9-x-to-10-0"><a href="#9-x-to-10-0" class="headerlink" title="9.x to 10.0"></a>9.x to 10.0</h3><p>If you are updating from 9.x to 10.0 or higher, run <code>pkg2ng</code> after rebooting into the new OS. This conversion script will convert the list of installed packages from the format used by the old <code>pkg_</code> tools to the format used by pkgng, the new binary package manager. If you neglect this step the OS will think you have no packages installed and your life will become very confusing.</p>
<h3 id="10-0-to-10-1"><a href="#10-0-to-10-1" class="headerlink" title="10.0 to 10.1"></a>10.0 to 10.1</h3><p><code>WITH_NEW_XORG</code> is no longer a thing. The old version is gone. <a href="http://www.freebsd.org/cgi/man.cgi?query=vt&amp;ektion=&amp;manpath=" title="man vt" target="_blank" rel="noopener">vt</a> is a new console driver designed to replace <a href="http://www.freebsd.org/cgi/man.cgi?query=syscons&amp;ektion=&amp;manpath=" title="man syscons" target="_blank" rel="noopener">syscons</a>. It offers Unicode and graphics support using kernel modesetting. This is necessary to support UEFI. A loader variable <code>kern.vty</code> can select between <code>vt</code> and <code>sc</code>. /boot/loader.conf</p>
<pre><code>kern.vty=vt
</code></pre><p>It will default to graphics mode but can be configured to use a text mode instead if necessary. /boot/loader.conf <code>hw.vga.textmode=1</code></p>

          
        
      
    </div>

    

    
    
    

    

    
       
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://hero.triple.net.cn/2017/08/06/e8-bd-ac-e6-b7-b1-e5-85-a5-e7-90-86-e8-a7-a3-e5-8f-8c-e5-9b-a0-e5-ad-90-e8-ae-a4-e8-af-81/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="$$ Welcome $$">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Technician">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2017/08/06/e8-bd-ac-e6-b7-b1-e5-85-a5-e7-90-86-e8-a7-a3-e5-8f-8c-e5-9b-a0-e5-ad-90-e8-ae-a4-e8-af-81/" class="post-title-link" itemprop="https://hero.triple.net.cn/page/8/index.html">[转]深入理解双因子认证</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2017-08-06 15:10:02" itemprop="dateCreated datePublished" datetime="2017-08-06T15:10:02+08:00">2017-08-06</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-12-12 17:13:19" itemprop="dateModified" datetime="2018-12-12T17:13:19+08:00">2018-12-12</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/技术分类/" itemprop="url" rel="index"><span itemprop="name">技术分类</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>关于两步验证，写的非常好的一篇文章。 来源： [Debug Hacks](<a href="http://blog.gaoyuan.xyz/2017/01/05/2fa-a-programmers-perspective/" target="_blank" rel="noopener">http://blog.gaoyuan.xyz/2017/01/05/2fa-a-programmers-perspective/</a>)</p>
<hr>
<p>  去年年初，让ops在服务器上开启了基于google-authenticator的双因子认证。最近花了点时间进行深入了解，记录如下。</p>
<h1 id="双因子认证的相关概念"><a href="#双因子认证的相关概念" class="headerlink" title="双因子认证的相关概念"></a>双因子认证的相关概念</h1><p>双因子认证（Two-factor authentication，也叫2FA），是一种通过组合两种不同的验证方式进行用户身份验证的机制。Google在2011年3月份，宣布在线上使用双因子认证，MSN和Yahoo紧随其后。 双因子认证，除了需要验证用户名密码外，还要结合另外一种实物设备，如Rsa令牌，或者手机。 如果我们把传统的用户名密码验证称为单因子认证（1FA），那么对比双因子认证（2FA），他们的区别如下：</p>
<blockquote>
<p>1FA – What you know (e.g. a password, a pin) 2FA – What you have (e.g. a phone, a hardware token) 3FA – What you are (e.g. your fingerprints, you retina)</p>
</blockquote>
<p>双因子认证的产品大致可以分成两类：</p>
<ul>
<li>可以产生token的硬件设备</li>
<li>智能手机的app</li>
</ul>
<p>手机短信验证码，登录微信公众号时的扫码确认都可以称为双因子认证。 双因子认证，还会结合一个只有你有的硬件设备。只要这个专属的硬件设备不丢失（察觉这个设备丢失，比用户名密码泄露，会容易很多），就可以大大地提升账号的安全性。</p>
<h1 id="双因子认证的实现"><a href="#双因子认证的实现" class="headerlink" title="双因子认证的实现"></a>双因子认证的实现</h1><p>[caption id=”” align=”alignleft” width=”1214”]<img src="https://tech.msla.top/wp-content/uploads/2018/04/flow.png" alt="Two-factor authentication flow" title="Two-factor authentication flow"> Two-factor authentication flow[/caption] 双因子认证的流程如下： 认证过程中涉及的token，一般会使用一次性密码(<a href="https://en.wikipedia.org/wiki/One-time_password" target="_blank" rel="noopener">One-time password</a>)，相关实现有：</p>
<ul>
<li>HOTP: 基于次数的一次性密码（<a href="https://tools.ietf.org/html/rfc4226" target="_blank" rel="noopener">HMAC-Based One-Time Password</a>）</li>
<li>TOTP: 基于时间的一次性密码（<a href="https://tools.ietf.org/html/rfc6238" target="_blank" rel="noopener">Time-Based One-Time Password</a>）</li>
</ul>
<p><code>HOTP</code>和<code>TOTP</code>的实现都基于<a href="https://tools.ietf.org/html/rfc2104" target="_blank" rel="noopener">HMAC-SHA-1</a>算法。 <code>HOTP</code>的生成算法如下</p>
<pre><code>HOTP(K,C) = Truncate(HMAC-SHA-1(K,C))
</code></pre><p>其中：</p>
<ul>
<li><code>C</code>是一个8-byte的自增变量。对于客户端，每生成一次性密码，其值加1。对于服务端，每次成功认证客户端产生的一次性密码，其值加1。在<code>HOTP</code>生成（客户端）和验证（服务端）过程中，C的值必须同步。</li>
<li><code>K</code>是客户端和服务端使用的共享密钥，每个客户端的<code>K</code>应该都是唯一的。</li>
</ul>
<p>生成步骤如下：</p>
<pre><code>Step 1: 使用HMAC-SHA-1算法，利用C和K，生成一个长度为20-byte的40个十六进制字符，即：HS = HMAC-SHA-1(K,C)
Step 2: 根据前面产品的字符串`HS`，生成一个长度为4-byte的8个十六进制字符，即：Sbits = DT(HS)，DT是根据HS，动态产生Sbits的方法，后面的示例中会提到
Step 3: 根据前面的Sbits，计算一个HOTP的值，一般为6位数字。
</code></pre><blockquote>
<p>2 nibbles (2 hex characters) = 1-byte</p>
</blockquote>
<p><code>TOTP</code>可以当做是<code>HOTP</code>算法的一个变种，可以将<code>TOTP</code>的生成算法定义为：</p>
<pre><code>TOTP = HOTP(K, T)
</code></pre><p><code>K</code>同<code>HOTP</code>算法中<code>K</code>的定义，是客户端和服务端使用的共享密钥，<code>T</code>是一个整数，定义如下：</p>
<pre><code>T = floor((Current Unix time - T0) / X)
</code></pre><p>其中：</p>
<ul>
<li><code>T0</code>是起始的Unix Time，默认为0</li>
<li><code>X</code>是<code>T</code>增长的步长，默认为30</li>
</ul>
<p>即<code>T</code>是以30为步长，当前的Unix Time距初始的Unix Time<code>T0</code>增长的数量。 如果<code>T0</code>=0，<code>X</code>=30，那么当此刻的Unix time是59时，<code>T</code>=1，当此刻的Unix time为60时，<code>T</code>=2。<code>TOTP</code>算法生成的一次性密码，就会每30s变更一次。</p>
<h1 id="一次性密码的生成过程"><a href="#一次性密码的生成过程" class="headerlink" title="一次性密码的生成过程"></a>一次性密码的生成过程</h1><p>本文以HMAC-SHA-1算法生成的字符串<code>HS</code>的值是<code>0215a7d8c15b492e21116482b6d34fc4e1a9f6ba</code>为例，介绍一次性密码的生成过程。 如果使用<code>TOTP</code>算法进行双因子认证，要让用户在30s内输入40个十六进制的字符，这是一件很难想象的事情。所以我们需要想个办法，将<code>HS</code>转换地更加便于输入，而又不失安全性。这就是前面提到的DT（Dynamic Truncation）的处理过程。 为了更清晰地展示生成过程，用下图表示<code>HS</code>： <img src="https://tech.msla.top/wp-content/uploads/2018/04/hotp_step1.png" alt="" title="Two-factor authentication step1"> 前面的图中包含40个字符，每个字符都占4-bits（有16个可能的值0-15），被分成了20组单独的字符串。 我们先去找<code>HS</code>的低4位（最后一个字符），作为截取字符串的起始位置。在我们的例子里，最后一个字符是<code>a</code>： <img src="https://tech.msla.top/wp-content/uploads/2018/04/hotp_step2.png" alt="" title="Two-factor authentication step2"> 将十六进制的字符<code>a</code>转成十进制数是<code>10</code>。 我们将第1组字符串的偏移量用<code>0</code>表示，以此类推，如下： <img src="https://tech.msla.top/wp-content/uploads/2018/04/hotp_step3.png" alt="" title="Two-factor authentication step3"> 然后，从字符串<code>HS</code>的第<code>10</code>个偏移量开始，截取<code>4</code>组字符串（或者是接下来的31-bits）。</p>
<blockquote>
<p>这样截取的最大偏移量是15+4=19，刚好没有越界</p>
</blockquote>
<p>因此，我们通过DT（Dynamic Truncation）处理，将<code>HS</code>转换后得到的字符串是<code>6482b6d3</code>： <img src="https://tech.msla.top/wp-content/uploads/2018/04/hotp_step4.png" alt="" title="Two-factor authentication step4"> 将十六进制的<code>6482b6d3</code>转成十进制数是<code>1686288083</code>。 因为我们需要一个6位的数字，所以和<code>1000000</code>进行取模运算：</p>
<pre><code>1686288083 modulo 1000000
</code></pre><p>最后的结果是：</p>
<pre><code>288083
</code></pre><h1 id="使用google-authenticator，开启服务器双因子认证"><a href="#使用google-authenticator，开启服务器双因子认证" class="headerlink" title="使用google-authenticator，开启服务器双因子认证"></a>使用google-authenticator，开启服务器双因子认证</h1><p>首先，去你喜欢的android应用市场，或者apple的appStore去安装：“Google Authenticator（google身份验证器）”。 然后登录要开启双因子认证登录的服务器，进行下面的操作。 安装依赖</p>
<pre><code>yum -y install gcc gcc-c++ make wget pam-devel
</code></pre><p>安装Google Authenticator</p>
<pre><code>wget http://google-authenticator.googlecode.com/files/libpam-google-authenticator-1.0-source.tar.bz2
tar jxvf libpam-google-authenticator-1.0-source.tar.bz2
cd libpam-google-authenticator-1.0
make
sudo make install
</code></pre><p>配置SSH登录时调用google-authenticator模块 编辑文件<code>/etc/pam.d/sshd</code>，添加：</p>
<pre><code>auth       required     pam_google_authenticator.so
</code></pre><p>编辑文件<code>/etc/ssh/sshd_config</code>，在文件中查找<code>ChallengeResponseAuthentication</code>和<code>UsePAM</code>，修改为如下内容：</p>
<pre><code>ChallengeResponseAuthentication yes
UsePAM yes
</code></pre><p>重启ssh</p>
<pre><code>sudo service ssh restart
</code></pre><p>下面是配置Google Authenticator的相关步骤。 如果要为用户<code>zhangsan</code>添加ssh登录时的双因子认证，执行如下命令：</p>
<p>1<br>2</p>
<pre><code>su - zhangsan
google-authenticator
</code></pre><p>会出现一串问题，让你选<code>y</code>或者<code>n</code>。</p>
<pre><code>Do you want authentication tokens to be time-based (y/n) y
https://www.google.com/chart?chs=200x200&amp;chld=M|0&amp;cht=qr&amp;chl=otpauth://totp/zhangsan@ali%3Fsecret%3DWKHM6UVJNTPYSPTQ
Your new secret key is: WKHM6UVJNTPYSPTQ
Your verification code is 434260
Your emergency scratch codes are:
30287010
70585905
68748337
15176712
38041521
</code></pre><p>上面的这一步，会生成一个base32编码的共享密钥<code>WKHM6UVJNTPYSPTQ</code>，即前面的<code>K</code>，用于在客户端进行绑定（如果可以翻墙的话，实际上会看到一张二维码，使用Google Authenticator app扫码即可以完成绑定）。 共享密钥使用base32而非base64的原因如下：</p>
<ul>
<li>base32编码的字符串，包含了大写英文字母和数字2-7。不会因字体显示问题，把1，8，0和’I’,‘B’, ‘O’混淆，更利于输入。</li>
<li>base32编码的字符串，出现在url中时，可以不用进行url编码处理（encode），便于直接使用生成二维码的web服务。</li>
</ul>
<p>同时，基于当前的Unix time，生成了一个动态验证码<code>434260</code>，可用于测试。并生成了5个应急备用验证码（上面的emergency scratch codes），可以在绑定设备丢失的情况下使用（每个应急码只能使用一次）。 剩下的问题，没有特殊癖好，可以都选<code>y</code>。</p>
<pre><code>Do you want me to update your &quot;/home/zhangsan/.google_authenticator&quot; file (y/n) y

Do you want to disallow multiple uses of the same authentication
token? This restricts you to one login about every 30s, but it increases
your chances to notice or even prevent man-in-the-middle attacks (y/n) y

By default, tokens are good for 30 seconds and in order to compensate for
possible time-skew between the client and the server, we allow an extra
token before and after the current time. If you experience problems with poor
time synchronization, you can increase the window from its default
size of 1:30min to about 4min. Do you want to do so (y/n) y

If the computer that you are logging into isn&apos;t hardened against brute-force
login attempts, you can enable rate-limiting for the authentication module.
By default, this limits attackers to no more than 3 login attempts every 30s.
Do you want to enable rate-limiting (y/n) y
</code></pre><p>之后，ssh登录服务器时，会看到类似这样的提示：</p>
<pre><code>verification code:
</code></pre><p>这时，打开手机上的google身份验证器App，输入对应的code，如下： <img src="https://tech.msla.top/wp-content/uploads/2018/04/google-authenticator.png" alt="" title="google 验证器 flow"> reference： [^1] <a href="https://pthree.org/2014/04/15/time-based-one-time-passwords-how-it-works/" target="_blank" rel="noopener">https://pthree.org/2014/04/15/time-based-one-time-passwords-how-it-works/</a> [^2] <a href="https://garbagecollected.org/2014/09/14/how-google-authenticator-works/" target="_blank" rel="noopener">https://garbagecollected.org/2014/09/14/how-google-authenticator-works/</a> [^3] <a href="https://www.blackmoreops.com/2014/06/26/securing-ssh-two-factor-authentication-using-google-authenticator/" target="_blank" rel="noopener">https://www.blackmoreops.com/2014/06/26/securing-ssh-two-factor-authentication-using-google-authenticator/</a></p>

          
        
      
    </div>

    

    
    
    

    

    
       
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://hero.triple.net.cn/2017/08/06/e5-be-b7-e5-85-b0-e4-bf-ae-e5-a5-b3-e7-ae-b4-e8-a8-80/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="$$ Welcome $$">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Technician">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2017/08/06/e5-be-b7-e5-85-b0-e4-bf-ae-e5-a5-b3-e7-ae-b4-e8-a8-80/" class="post-title-link" itemprop="https://hero.triple.net.cn/page/8/index.html">德兰修女 箴言</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2017-08-06 13:49:19" itemprop="dateCreated datePublished" datetime="2017-08-06T13:49:19+08:00">2017-08-06</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-12-12 17:08:58" itemprop="dateModified" datetime="2018-12-12T17:08:58+08:00">2018-12-12</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/技术分类/" itemprop="url" rel="index"><span itemprop="name">技术分类</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>人们经常是不讲道理的、没有逻辑的和以自我为中心的 不管怎样，你要原谅他们 即使你是友善的，人们可能还是会说你自私和动机不良 不管怎样，你还是要友善 当你功成名就，你会有一些虚假的朋友 和一些真实的敌人 不管怎样，你还是要取得成功 即使你是诚实的和率直的，人们可能还是会欺骗你 不管怎样，你还是要诚实和率直 你多年来营造的东西 有人在一夜之间把它摧毁 不管怎样，你还是要去营造 如果你找到了平静和幸福，他们可能会嫉妒你 不管怎样，你还是要快乐 你今天做的善事，人们往往明天就会忘记 不管怎样，你还是要做善事 即使把你最好的东西给了这个世界 也许这些东西永远都不够 不管怎样，把你最好的东西给这个世界 你看，说到底，它是你和上帝之间的事 而决不是你和他人之间的事</p>
</blockquote>

          
        
      
    </div>

    

    
    
    

    

    
       
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://hero.triple.net.cn/2017/08/02/jms-e5-8f-91-e5-b8-83-e8-ae-a2-e9-98-85-e6-b6-88-e6-81-af-e4-bc-a0-e9-80-81-e4-be-8b-e5-ad-90/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="$$ Welcome $$">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Technician">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2017/08/02/jms-e5-8f-91-e5-b8-83-e8-ae-a2-e9-98-85-e6-b6-88-e6-81-af-e4-bc-a0-e9-80-81-e4-be-8b-e5-ad-90/" class="post-title-link" itemprop="https://hero.triple.net.cn/page/8/index.html">JMS发布/订阅消息传送例子</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2017-08-02 05:14:04" itemprop="dateCreated datePublished" datetime="2017-08-02T05:14:04+08:00">2017-08-02</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-12-12 17:19:37" itemprop="dateModified" datetime="2018-12-12T17:19:37+08:00">2018-12-12</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/技术分类/" itemprop="url" rel="index"><span itemprop="name">技术分类</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="在Tomcat中配置JNDI"><a href="#在Tomcat中配置JNDI" class="headerlink" title="在Tomcat中配置JNDI"></a>在Tomcat中配置JNDI</h1><p>配置连接工厂和话题 <a href="#" title="复制代码"><img src="https://w.msla.top/wordpress/wp-content/uploads/2017/08/51e409b11aa51c150090697429a953ed.gif" alt=""></a></p>
<pre><code>&lt;Resource name=&quot;topic/connectionFactory&quot; auth=&quot;Container&quot;
    type=&quot;org.apache.activemq.ActiveMQConnectionFactory&quot; description=&quot;JMS Connection Factory&quot;
    factory=&quot;org.apache.activemq.jndi.JNDIReferenceFactory&quot;
    brokerURL=&quot;failover:(tcp://localhost:61616)?initialReconnectDelay=100&amp;amp;maxReconnectAttempts=5&quot;
    brokerName=&quot;LocalActiveMQBroker&quot; useEmbeddedBroker=&quot;false&quot; /&gt;

&lt;Resource name=&quot;topic/topic0&quot; 
    auth=&quot;Container&quot;
    type=&quot;org.apache.activemq.command.ActiveMQTopic&quot; description=&quot;My Topic&quot; factory=&quot;org.apache.activemq.jndi.JNDIReferenceFactory&quot;
    physicalName=&quot;TestTopic&quot; /&gt;
</code></pre><h1 id="在Web工厂中编写代码"><a href="#在Web工厂中编写代码" class="headerlink" title="在Web工厂中编写代码"></a>在Web工厂中编写代码</h1><p>新建一个发布者Servlet</p>
<p>package pubSub;</p>
<p>import java.io.IOException;<br>import java.io.PrintWriter;</p>
<p>import javax.naming.InitialContext;<br>import javax.servlet.ServletException;<br>import javax.servlet.annotation.WebServlet;<br>import javax.servlet.http.HttpServlet;<br>import javax.servlet.http.HttpServletRequest;<br>import javax.servlet.http.HttpServletResponse;<br>import javax.jms.Topic;<br>import javax.jms.Session;<br>import javax.jms.TextMessage;<br>import javax.jms.TopicPublisher;<br>import javax.jms.DeliveryMode;<br>import javax.jms.TopicSession;<br>import javax.jms.TopicConnection;<br>import javax.jms.TopicConnectionFactory;</p>
<p>/**<br> * Servlet implementation class JMSTest<br> */<br>@WebServlet(“/Publish”)<br>public class Publisher extends HttpServlet {<br>    private static final long serialVersionUID = 1L;</p>
<pre><code>/\*\*
 \* @see HttpServlet#HttpServlet()
 */
public Publisher() {
    super();
    // TODO Auto-generated constructor stub
}

/\*\*
 \* @see HttpServlet#doGet(HttpServletRequest request, HttpServletResponse
 \*      response)
 */
protected void doGet(HttpServletRequest request,
        HttpServletResponse response) throws ServletException, IOException {
    PrintWriter out = response.getWriter();

    try {
        // get the initial context
        InitialContext ctx = new InitialContext();

        // lookup the topic object
        Topic topic = (Topic) ctx.lookup(&quot;java:comp/env/topic/topic0&quot;);

        // lookup the topic connection factory
        TopicConnectionFactory connFactory = (TopicConnectionFactory) ctx
                .lookup(&quot;java:comp/env/topic/connectionFactory&quot;);

        // create a topic connection
        TopicConnection topicConn = connFactory.createTopicConnection();

        // create a topic session
        TopicSession topicSession = topicConn.createTopicSession(false,
                Session.AUTO_ACKNOWLEDGE);

        // create a topic publisher
        TopicPublisher topicPublisher = topicSession.createPublisher(topic);
        topicPublisher.setDeliveryMode(DeliveryMode.NON_PERSISTENT);

        // create the &quot;Hello World&quot; message
        TextMessage message = topicSession.createTextMessage();
        message.setText(&quot;Hello World&quot;);

        // publish the messages
        topicPublisher.publish(message);

        // print what we did
        out.write(&quot;Message published: &quot; + message.getText());

        // close the topic connection
        topicConn.close();
    } catch (Exception e) {
        // TODO Auto-generated catch block
        e.printStackTrace();
    }

}

/\*\*
 \* @see HttpServlet#doPost(HttpServletRequest request, HttpServletResponse
 \*      response)
 */
protected void doPost(HttpServletRequest request,
        HttpServletResponse response) throws ServletException, IOException {
    // TODO Auto-generated method stub
}
</code></pre><p>}</p>
<p><a href="#" title="复制代码"><img src="https://w.msla.top/wordpress/wp-content/uploads/2017/08/51e409b11aa51c150090697429a953ed.gif" alt=""></a> 新建一个订阅者Servlet <a href="#" title="复制代码"><img src="https://w.msla.top/wordpress/wp-content/uploads/2017/08/51e409b11aa51c150090697429a953ed.gif" alt=""></a></p>
<p>package pubSub;</p>
<p>import java.io.IOException;<br>import java.io.PrintWriter;</p>
<p>import javax.jms.Session;<br>import javax.jms.TextMessage;<br>import javax.jms.Topic;<br>import javax.jms.TopicConnection;<br>import javax.jms.TopicConnectionFactory;<br>import javax.jms.TopicSession;<br>import javax.jms.TopicSubscriber;<br>import javax.naming.InitialContext;<br>import javax.servlet.ServletException;<br>import javax.servlet.annotation.WebServlet;<br>import javax.servlet.http.HttpServlet;<br>import javax.servlet.http.HttpServletRequest;<br>import javax.servlet.http.HttpServletResponse;</p>
<p>/**<br> * Servlet implementation class Receive<br> */<br>@WebServlet(“/Subscribe”)<br>public class Subscriber extends HttpServlet {<br>    private static final long serialVersionUID = 1L;</p>
<pre><code>/\*\*
 \* @see HttpServlet#HttpServlet()
 */
public Subscriber() {
    super();
    // TODO Auto-generated constructor stub
}

/\*\*
 \* @see HttpServlet#doGet(HttpServletRequest request, HttpServletResponse
 \*      response)
 */
protected void doGet(HttpServletRequest request,
        HttpServletResponse response) throws ServletException, IOException {
    PrintWriter out = response.getWriter();

    try {
        // get the initial context
        InitialContext ctx = new InitialContext();

        // lookup the topic object
        Topic topic = (Topic) ctx.lookup(&quot;java:comp/env/topic/topic0&quot;);

        // lookup the topic connection factory
        TopicConnectionFactory connFactory = (TopicConnectionFactory) ctx
                .lookup(&quot;java:comp/env/topic/connectionFactory&quot;);

        // create a topic connection
        TopicConnection topicConn = connFactory.createTopicConnection();

        // create a topic session
        TopicSession topicSession = topicConn.createTopicSession(false,
                Session.AUTO_ACKNOWLEDGE);

        // create a topic subscriber
        TopicSubscriber topicSubscriber = topicSession
                .createSubscriber(topic);

        // start the connection
        topicConn.start();

        // receive the message
        TextMessage message = (TextMessage) topicSubscriber.receive();

        // print the message
        out.write(&quot;Message received: &quot; + message.getText());

        // close the topic connection
        topicConn.close();
    } catch (Exception e) {
        // TODO Auto-generated catch block
        e.printStackTrace();
    }
}

/\*\*
 \* @see HttpServlet#doPost(HttpServletRequest request, HttpServletResponse
 \*      response)
 */
protected void doPost(HttpServletRequest request,
        HttpServletResponse response) throws ServletException, IOException {
    // TODO Auto-generated method stub
}
</code></pre><p>}</p>
<p><a href="#" title="复制代码"><img src="https://w.msla.top/wordpress/wp-content/uploads/2017/08/51e409b11aa51c150090697429a953ed.gif" alt=""></a> 运行Web工程，分别打开多个标签访问订阅servlet，然后访问发布servlet，结果如下： <img src="https://w.msla.top/wordpress/wp-content/uploads/2017/08/48b9eb826fea9ca588ab3a0b3adfdf4a.jpg" alt=""> <img src="https://w.msla.top/wordpress/wp-content/uploads/2017/08/48b9eb826fea9ca588ab3a0b3adfdf4a.jpg" alt=""> <img src="https://w.msla.top/wordpress/wp-content/uploads/2017/08/c7dfa2cd42d923c755639abe24e2fa11.jpg" alt=""> 在订阅者订阅消息的时候，一开始没接收到消息，一旦发布者发布消息后，订阅者马上收到消息。 </p>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p><a href="http://howtodoinjava.com/jms/jms-publish-subscribe-message-example/" target="_blank" rel="noopener">http://howtodoinjava.com/jms/jms-publish-subscribe-message-example/</a></p>

          
        
      
    </div>

    

    
    
    

    

    
       
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://hero.triple.net.cn/2017/08/01/fastdfs-e4-bb-a5-e5-ad-97-e8-8a-82-e6-96-b9-e5-bc-8f-e4-b8-8a-e4-bc-a0-e6-96-87-e4-bb-b6/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="$$ Welcome $$">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Technician">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2017/08/01/fastdfs-e4-bb-a5-e5-ad-97-e8-8a-82-e6-96-b9-e5-bc-8f-e4-b8-8a-e4-bc-a0-e6-96-87-e4-bb-b6/" class="post-title-link" itemprop="https://hero.triple.net.cn/page/8/index.html">FastDFS 以字节方式上传文件</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2017-08-01 03:40:42" itemprop="dateCreated datePublished" datetime="2017-08-01T03:40:42+08:00">2017-08-01</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-12-12 17:19:14" itemprop="dateModified" datetime="2018-12-12T17:19:14+08:00">2018-12-12</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/技术分类/" itemprop="url" rel="index"><span itemprop="name">技术分类</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>在阅读本文之前，请您先通过<a href="http://blog.csdn.net/poechant/article/details/6977407" target="_blank" rel="noopener">《FastDFS的配置、部署与API使用解读（1）Get Started with FastDFS》</a>一文中给出的参考博文中的部署篇和测试篇来完成前期的准备工作。 1、下载FastDFS的API FastDFS提供Java和PHP等语言的客户端API。可以到FastDFS在Google Code的项目主页 <a href="http://code.google.com/p/fastdfs/downloads/list" target="_blank" rel="noopener">http://code.google.com/p/fastdfs/downloads/list</a> 下载。本文以Java API为例。 2、调用API的上传接口 通过Servlet得到InputStream、文件名称和文件长度，然后通过调用FastDFS提供的Java API把文件上传到FastDFS服务器。下段代码中的getFileBuffer可参考本博客上一篇博文。（by Poechant）</p>
<ol>
<li>/** </li>
<li><ul>
<li>Upload File to DFS. </li>
</ul>
</li>
<li><ul>
<li>@param fileBuff, file to be uploaded. </li>
</ul>
</li>
<li><ul>
<li>@param uploadFileName, the name of the file. </li>
</ul>
</li>
<li><ul>
<li>@param fileLength, the length of the file. </li>
</ul>
</li>
<li><ul>
<li>@return the file ID in DFS. </li>
</ul>
</li>
<li><ul>
<li>@throws IOException  </li>
</ul>
</li>
<li>*/</li>
<li>public String uploadFile(InputStream inStream, String uploadFileName, long fileLength) throws IOException {  </li>
<li>byte[] fileBuff = getFileBuffer(inStream, fileLength);  </li>
<li>String fileId = “”;  </li>
<li>String fileExtName = “”;  </li>
<li>if (uploadFileName.contains(“.”)) {  </li>
<li>fileExtName = uploadFileName.substring(uploadFileName.lastIndexOf(“.”) + 1);  </li>
<li>} else {  </li>
<li>logger.warn(“Fail to upload file, because the format of filename is illegal.”);  </li>
<li>return fileId;  </li>
<li><p>}  </p>
</li>
<li><p>//建立连接</p>
</li>
<li>TrackerClient tracker = new TrackerClient();  </li>
<li>TrackerServer trackerServer = tracker.getConnection();  </li>
<li>StorageServer storageServer = null;  </li>
<li><p>StorageClient1 client = new StorageClient1(trackerServer, storageServer);  </p>
</li>
<li><p>//设置元信息</p>
</li>
<li>NameValuePair[] metaList = new NameValuePair[3];  </li>
<li>metaList[0] = new NameValuePair(“fileName”, uploadFileName);  </li>
<li>metaList[1] = new NameValuePair(“fileExtName”, fileExtName);  </li>
<li><p>metaList[2] = new NameValuePair(“fileLength”, String.valueOf(fileLength));  </p>
</li>
<li><p>//上传文件</p>
</li>
<li>try {  </li>
<li>fileId = client.upload_file1(fileBuff, fileExtName, metaList);  </li>
<li>} catch (Exception e) {  </li>
<li>logger.warn(“Upload file “” + uploadFileName + “”fails”);  </li>
<li>}  </li>
<li>trackerServer.close();  </li>
<li>return fileId;  </li>
<li><p>}  </p>
<p>3、调用方式详解 （1）客户端与Tracker Server通信 根据《FastDFS的配置、部署与API使用解读（1）Get Started with FastDFS》一文中提供的FastDFS的工作原理，结合上面的代码，首先通过TrackerClient构造函数从全局配置中获取Tracker Servers的IP和端口初始化一个TrackerClient对象tracker，并与其建立连接，我们可以从API的源码中看到：</p>
</li>
<li><p>/** </p>
</li>
<li><ul>
<li>constructor with global tracker group </li>
</ul>
</li>
<li>*/</li>
<li>public TrackerClient()  </li>
<li>{  </li>
<li>this.tracker_group = ClientGlobal.g_tracker_group;  </li>
<li>}     </li>
<li>/** </li>
<li><ul>
<li>constructor with specified tracker group </li>
</ul>
</li>
<li><ul>
<li>@param tracker_group the tracker group object </li>
</ul>
</li>
<li>*/</li>
<li>public TrackerClient(TrackerGroup tracker_group)  </li>
<li>{  </li>
<li>this.tracker_group = tracker_group;  </li>
<li><p>}  </p>
<p>上述代码中ClientGlobal是一个提供很多静态成员供外部读取的类。通过tracker这个TrackerClient建立的与Tracker Server的连接，实例化了一个trackerServer对象。   （2）客户端与Storage Server通信 通过trackerServer取得某一个可用的Storage Server的地址并用其实例化一个StorageClient1对象。这样就完成了FastDFS的客户端调用上传、下载、删除等所有操作的前期建立连接的工作。 （3）调用文件操作API 这些操作包括upload、download、append、delete等。上例中提供的是上传的实例。</p>
</li>
</ol>

          
        
      
    </div>

    

    
    
    

    

    
       
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://hero.triple.net.cn/2017/08/01/fastdfs-e5-9c-a8-centos-e4-b8-8b-e9-85-8d-e7-bd-ae-e5-ae-89-e8-a3-85-e9-83-a8-e7-bd-b2/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="$$ Welcome $$">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Technician">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2017/08/01/fastdfs-e5-9c-a8-centos-e4-b8-8b-e9-85-8d-e7-bd-ae-e5-ae-89-e8-a3-85-e9-83-a8-e7-bd-b2/" class="post-title-link" itemprop="https://hero.triple.net.cn/page/8/index.html">FastDFS 在 CentOS 下配置安装部署</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2017-08-01 02:20:55" itemprop="dateCreated datePublished" datetime="2017-08-01T02:20:55+08:00">2017-08-01</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-12-12 17:19:14" itemprop="dateModified" datetime="2018-12-12T17:19:14+08:00">2018-12-12</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/技术分类/" itemprop="url" rel="index"><span itemprop="name">技术分类</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>centos安装fastdfs</p>
<h1 id="少啰嗦，直接装"><a href="#少啰嗦，直接装" class="headerlink" title="少啰嗦，直接装"></a>少啰嗦，直接装</h1><p>看过上一篇<a href="http://blog.mayongfa.cn/191.html" target="_blank" rel="noopener">分布式文件系统 - FastDFS 简单了解一下</a>的朋友应该知道，本次安装是使用目前余庆老师开源的最新 V5.05 版本，是余庆老师放在 <a href="https://github.com/happyfish100/fastdfs" target="_blank" rel="noopener">Github</a> 上的，和目前你能在网络上搜索到的 Google Code 的 V4.06 或更低版本不一样，而且按照他们的步骤坑很多，我反正被坑了很久。 你只需要记住，这也许是目前 FastDFS 最新最稳定最简单坑最少的一个配置安装部署教程了。期间我也会把我踩的坑都放出来，我保证大家照着做就几乎不会有坑。哈哈…</p>
<h1 id="安装-libfastcommon-和-FastDFS"><a href="#安装-libfastcommon-和-FastDFS" class="headerlink" title="安装 libfastcommon 和 FastDFS"></a>安装 libfastcommon 和 FastDFS</h1><p>1.<strong>下载安装 libfastcommon</strong> ，这里是通过<code>wget</code>下载（我喜欢这种方式）。 <code>wget https://github.com/happyfish100/libfastcommon/archive/V1.0.7.tar.gz</code> 压 libfastcommon，命令： <code>tar -zxvf V1.0.7.tar.gz</code> 编译，进入<code>libfastcommon-1.0.7</code>目录，命令： <code>cd libfastcommon-1.0.7./make.sh</code> 安装，命令： <code>./make.sh install</code> 2.<strong>下载安装 FastDFS</strong>，这里也是通过<code>wget</code>下载。 <code>wget https://github.com/happyfish100/fastdfs/archive/V5.05.tar.gz</code> 解压 FastDFS ，命令： <code>tar -zxvf V5.05.tar.gz</code> 编译，进入<code>fastfds-5.05</code>目录，命令： <code>cd fastdfs-5.05./make.sh</code> 安装，命令： <code>./make.sh install</code>   <strong>配置 Tracker 服务</strong> 上述安装成功后，在<code>/etc/</code>目录下会有一个<code>fdfs</code>的目录，进入它。会看到三个<code>.sample</code>后缀的文件，这是作者给我们的示例文件，我们需要把其中的<code>tracker.conf.sample</code>文件改为<code>tracker.conf</code>配置文件并修改它。看命令：</p>
<pre><code>cp tracker.conf.sample tracker.conf
vim tracker.conf
</code></pre><p>打开<code>tracker.conf</code>文件，只需要找到你只需要该这两个参数就可以了。</p>
<pre><code># the base path to store data and log files
base_path=/data/fastdfs

# HTTP port on this tracker server
http.server_port=80
</code></pre><p>当然前提是你要有或先创建了<code>/data/fastdfs</code>目录。<code>port=22122</code>这个端口参数不建议修改，除非你已经占用它了。 修改完成保存并退出 vim ，这时候我们可以使用<code>/usr/bin/fdfs_trackerd /etc/fdfs/tracker.conf start</code>来启动 Tracker服务，但是这个命令不够优雅，怎么做呢？使用<code>ln -s</code> 建立软链接：</p>
<pre><code>ln -s /usr/bin/fdfs_trackerd /usr/local/bin
ln -s /usr/bin/stop.sh /usr/local/bin
ln -s /usr/bin/restart.sh /usr/local/bin
</code></pre><p>这时候我们就可以使用<code>service fdfs_trackerd start</code>来优雅地启动 Tracker服务了，是不是比刚才带目录的命令好记太多了（懒是社会生产力）。你也可以启动过服务看一下端口是否在监听，命令：</p>
<pre><code>启动服务：service fdfs_trackerd start
查看监听：netstat -unltp|grep fdfs
</code></pre><p>看到<code>22122端口</code>正常被监听后，这时候就算 Tracker服务安装成功啦！</p>
<h1 id="配置-Storage-服务"><a href="#配置-Storage-服务" class="headerlink" title="配置 Storage 服务"></a>配置 Storage 服务</h1><p>现在开始配置 Storage 服务，由于我这是单机器测试，你把 Storage 服务放在多台服务器也是可以的，它有 <code>Group(组)</code>的概念，同一组内服务器互备同步，这里不再演示。直接开始配置，依然是进入<code>/etc/fdfs</code>的目录操作，首先进入它。会看到三个<code>.sample</code>后缀的文件，我们需要把其中的<code>storage.conf.sample</code>文件改为<code>storage.conf</code>配置文件并修改它。还看命令：</p>
<pre><code>cp storage.conf.sample storage.conf
vim storage.conf
</code></pre><p>打开<code>storage.conf</code>文件后，找到这两个参数进行修改：</p>
<pre><code># the base path to store data and log files
base_path=/data/fastdfs/storage

# store_path#, based 0, if store_path0 not exists, it&apos;s value is base_path
# the paths must be exist
store_path0=/data/fastdfs/storage
#store_path1=/home/yuqing/fastdfs2

# tracker_server can ocur more than once, and tracker_server format is
#  &quot;host:port&quot;, host can be hostname or ip address
tracker_server=192.168.198.129:22122
</code></pre><p>当然你的<code>/data/fastdfs</code>目录下要有<code>storage</code>文件夹，没有就创建一个，不然会报错的，日志以及文件都会在这个下面，启动时候会自动生成许多文件夹。stroage的<code>port=23000</code>这个端口参数也不建议修改，默认就好，除非你已经占用它了。 修改完成保存并退出 vim ，这时候我们依然想优雅地启动 Storage服务，带目录的命令不够优雅，这里还是使用<code>ln -s</code> 建立软链接：</p>
<pre><code>ln -s /usr/bin/fdfs_storaged /usr/local/bin
</code></pre><p>执行命令启动服务：</p>
<pre><code>service fdfs_storaged start
</code></pre><p><code>netstat -unltp|grep fdfs</code> 很好，<code>22122 和 23000</code>端口都在监听了，这个时候你去<code>/data/fastdfs/storage</code>文件夹下看的话，会出现一大堆文件夹，而且进去还有一大堆，哈哈，这就是存放文件的啦！下一篇会讲它们的作用和怎么存储的。</p>
<h1 id="这就完成了？"><a href="#这就完成了？" class="headerlink" title="这就完成了？"></a>这就完成了？</h1><p>应该是完成了。我们安装配置并启动了 Tracker 和 Storage 服务，也没有报错了。那他俩是不是在通信呢？我们可以监视一下： <code>/usr/bin/fdfs_monitor /etc/fdfs/storage.conf</code> 这个时候你就可以进行上传测试 这篇文章只是进行了 FastDFS 的安装与配置，没有任何难度可言，只要按照步骤一步步走下去就可以搞定。可能中间过程中我们会由于不细心经历各种错误，只要仔细看日志信息都能解决掉的，你解决掉一个个错误的时候难道没有披荆斩棘战士般的感觉么？反正我没遇到错… 由于余老师在 V4.05 以后的版本就把内置 HTTP服务去掉了，推荐大家结合 Nginx 使用 fastdfs-nginx-module 模块，所以，就算这篇你测试上传成功了，你也访问不了，哈哈哈… 下一篇<a href="http://blog.mayongfa.cn/193.html" target="_blank" rel="noopener">分布式文件系统 - FastDFS 配置 Nginx 模块及上传测试</a> 中会进行配合 Nginx 完成全部FastDFS的安装测试上传下载等等全部工作。等着吧…</p>

          
        
      
    </div>

    

    
    
    

    

    
       
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://hero.triple.net.cn/2017/07/31/java-e5-b7-b2-e7-9f-a5inputstream-e9-95-bf-e5-ba-a6-ef-bc-8c-e5-b0-86-e5-85-b6-e8-bd-ac-e6-8d-a2-e4-b8-babyte/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="$$ Welcome $$">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Technician">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2017/07/31/java-e5-b7-b2-e7-9f-a5inputstream-e9-95-bf-e5-ba-a6-ef-bc-8c-e5-b0-86-e5-85-b6-e8-bd-ac-e6-8d-a2-e4-b8-babyte/" class="post-title-link" itemprop="https://hero.triple.net.cn/page/8/index.html">Java已知InputStream长度，将其转换为byte[]</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2017-07-31 16:02:19" itemprop="dateCreated datePublished" datetime="2017-07-31T16:02:19+08:00">2017-07-31</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-12-12 17:19:37" itemprop="dateModified" datetime="2018-12-12T17:19:37+08:00">2018-12-12</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/技术分类/" itemprop="url" rel="index"><span itemprop="name">技术分类</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>###Java已知InputStream长度，将其转换为byte[] <code>/** * Transfer java.io.InpuStream to byte array. * @param inStream, input stream of the uploaded file. * @param fileLength, the length of the file. * @return the byte array transferred from java.io.Inputstream. * @throws IOException occurred by the method read(byte\[\]) of java.io.InputStream. */ private byte\[\] getFileBuffer(InputStream inStream, long fileLength) throws IOException { byte\[\] buffer = new byte\[256 * 1024\]; byte\[\] fileBuffer = new byte\[(int) fileLength\]; int count = 0; int length = 0; while((length = inStream.read(buffer)) != -1){ for (int i = 0; i &lt; length; ++i) { fileBuffer\[count + i\] = buffer\[i\]; } count += length; } return fileBuffer; }</code></p>

          
        
      
    </div>

    

    
    
    

    

    
       
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/7/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/">7</a><span class="page-number current">8</span><a class="page-number" href="/page/9/">9</a><span class="space">&hellip;</span><a class="page-number" href="/page/18/">18</a><a class="extend next" rel="next" href="/page/9/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">John Doe</p>
              <p class="site-description motion-element" itemprop="description">$$ Welcome $$</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">174</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">9</span>
                    <span class="site-state-item-name">分类</span>
                  
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">214</span>
                    <span class="site-state-item-name">标签</span>
                  
                </div>
              
            </nav>
          

          

          

          

          
          

          
            
          
          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">John Doe</span>

  

  
</div>









        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    
	
    

    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>














  
    
      
        
      
  
  <script type="text/javascript" color="0,0,255" opacity="0.5" zindex="-1" count="99" src="//cdn.jsdelivr.net/gh/theme-next/theme-next-canvas-nest@1.0.0/canvas-nest.min.js"></script>











  



  
  
    <script type="text/javascript" src="//cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/reading_progress/reading_progress.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.6.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.6.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=6.6.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=6.6.0"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.6.0"></script>



  



  










  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  

  
  

  

  

  

  
  
  
  <script src="/lib/bookmark/bookmark.min.js?v=1.0"></script>
  <script type="text/javascript">
  
    bookmark.loadBookmark();
  
  </script>


  
  <style>
    .copy-btn {
      display: inline-block;
      padding: 6px 12px;
      font-size: 13px;
      font-weight: 700;
      line-height: 20px;
      color: #333;
      white-space: nowrap;
      vertical-align: middle;
      cursor: pointer;
      background-color: #eee;
      background-image: linear-gradient(#fcfcfc, #eee);
      border: 1px solid #d5d5d5;
      border-radius: 3px;
      user-select: none;
      outline: 0;
    }

    .highlight-wrap .copy-btn {
      transition: opacity .3s ease-in-out;
      opacity: 0;
      padding: 2px 6px;
      position: absolute;
      right: 4px;
      top: 8px;
    }

    .highlight-wrap:hover .copy-btn,
    .highlight-wrap .copy-btn:focus {
      opacity: 1
    }

    .highlight-wrap {
      position: relative;
    }
  </style>
  <script>
    $('.highlight').each(function (i, e) {
      var $wrap = $('<div>').addClass('highlight-wrap')
      $(e).after($wrap)
      $wrap.append($('<button>').addClass('copy-btn').append('复制').on('click', function (e) {
        var code = $(this).parent().find('.code').find('.line').map(function (i, e) {
          return $(e).text()
        }).toArray().join('\n')
        var ta = document.createElement('textarea')
        document.body.appendChild(ta)
        ta.style.position = 'absolute'
        ta.style.top = '0px'
        ta.style.left = '0px'
        ta.value = code
        ta.select()
        ta.focus()
        var result = document.execCommand('copy')
        document.body.removeChild(ta)
        
          if(result)$(this).text('复制成功')
          else $(this).text('复制失败')
        
        $(this).blur()
      })).on('mouseleave', function (e) {
        var $b = $(this).find('.copy-btn')
        setTimeout(function () {
          $b.text('复制')
        }, 300)
      }).append(e)
    })
  </script>


  

</body>
</html>
